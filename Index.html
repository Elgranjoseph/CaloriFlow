<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CaloriFlow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937, #020617);
      color: #e5e7eb;
      min-height: 100vh;
    }
    .app {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px 12px 40px;
    }
    h1 {
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 18px;
    }
    .card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 18px;
      padding: 16px 14px 18px;
      box-shadow: 0 18px 35px rgba(15,23,42,0.7);
      border: 1px solid rgba(148, 163, 184, 0.15);
    }
    label {
      font-size: 0.85rem;
      color: #cbd5f5;
      margin-bottom: 4px;
      display: block;
    }
    select, textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      padding: 10px 11px;
      font-size: 0.92rem;
      color: #e5e7eb;
      outline: none;
    }
    textarea {
      min-height: 70px;
      resize: vertical;
    }
    select:focus, textarea:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.7);
    }
    .field {
      margin-bottom: 10px;
    }
    .btn-row {
      display: flex;
      gap: 8px;
      margin: 10px 0 4px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 11px 14px;
      font-size: 0.94rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.12s ease;
      white-space: nowrap;
    }
    button:active {
      transform: scale(0.97);
    }
    .btn-primary {
      flex: 1;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      box-shadow: 0 12px 24px rgba(34, 197, 94, 0.55);
    }
    .btn-primary:disabled {
      opacity: 0.5;
      box-shadow: none;
    }
    .btn-secondary {
      flex: 1;
      background: rgba(30, 64, 175, 0.9);
      color: #e5e7eb;
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.5);
    }
    .btn-outline {
      width: 100%;
      margin-top: 10px;
      background: transparent;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: #e5e7eb;
    }
    .small-note {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-top: 6px;
      line-height: 1.3;
    }
    .tag-suggestion {
      font-size: 0.8rem;
      color: #22c55e;
      margin-top: 4px;
    }
    /* Vista resumen */
    .view {
      display: none;
    }
    .view.active {
      display: block;
    }
    .top-back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 14px;
      padding: 7px 11px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.95);
      font-size: 0.84rem;
      color: #e5e7eb;
    }
    .summary-title {
      font-size: 1.4rem;
      margin-bottom: 10px;
      font-weight: 700;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.92rem;
      margin-bottom: 4px;
    }
    .summary-row span:last-child {
      font-weight: 600;
    }
    .section-title {
      margin-top: 14px;
      margin-bottom: 4px;
      font-size: 0.96rem;
      font-weight: 600;
    }
    .progress-bar {
      width: 100%;
      height: 5px;
      border-radius: 999px;
      background: rgba(30, 64, 175, 0.4);
      overflow: hidden;
      margin-top: 3px;
      margin-bottom: 4px;
    }
    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      transition: width 0.25s ease;
    }
    .goal-row {
      font-size: 0.82rem;
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      color: #cbd5f5;
    }
    .advice-text {
      font-size: 0.82rem;
      color: #9ca3af;
      margin-top: 8px;
    }
    .meals-list {
      margin-top: 8px;
      border-top: 1px solid rgba(55, 65, 81, 0.8);
      padding-top: 8px;
    }
    .meal-item {
      padding: 8px 0;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
    }
    .meal-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.82rem;
      margin-bottom: 2px;
    }
    .meal-header-row strong {
      font-size: 0.86rem;
    }
    .meal-time {
      color: #9ca3af;
    }
    .meal-desc {
      font-size: 0.9rem;
      margin-bottom: 2px;
    }
    .meal-macros {
      font-size: 0.8rem;
      color: #cbd5f5;
    }
    .btn-delete {
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 0.78rem;
      background: rgba(239, 68, 68, 0.16);
      color: #fecaca;
      border: 1px solid rgba(239, 68, 68, 0.5);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-delete span {
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Vista principal: registro -->
    <div id="view-registro" class="view active">
      <h1>CaloriFlow</h1>
      <div class="subtitle">Registro diario con ‚Äúmemoria‚Äù de tus comidas.</div>

      <div class="card">
        <div class="field">
          <label for="tipoComida">Tipo de comida</label>
          <select id="tipoComida">
            <option>Desayuno</option>
            <option>Almuerzo</option>
            <option>Merienda</option>
            <option>Cena</option>
            <option>Snack</option>
          </select>
        </div>

        <div class="field">
          <label for="itemsInput">¬øQu√© comiste?</label>
          <textarea id="itemsInput" placeholder="Ej: 1 taza de Caf√© con leche&#10;1 tostada con mermelada"></textarea>
        </div>

        <div class="btn-row">
          <button id="btnPrompt" type="button" class="btn-secondary">
            üß† Generar prompt para ChatGPT
          </button>
          <button id="btnAddMeal" type="button" class="btn-primary">
            ‚úîÔ∏è Agregar comida
          </button>
        </div>

        <div class="field" style="margin-top:8px;">
          <label for="gptJsonInput">Pega aqu√≠ el resultado de ChatGPT (JSON)</label>
          <textarea id="gptJsonInput" placeholder='Ej: {"calorias":120,"azucares_g":10,"grasas_g":4,"proteinas_g":6}'></textarea>
        </div>

        <div id="templateHint" class="tag-suggestion"></div>

        <button id="btnResumen" type="button" class="btn-outline">
          üìä Ver resumen de hoy
        </button>
      </div>

      <p class="small-note">
        Si ya registraste una comida igual antes, pod√©s dejar vac√≠o el JSON y la app usar√° los valores que ya aprendi√≥.
      </p>
    </div>

    <!-- Vista resumen -->
    <div id="view-resumen" class="view">
      <button id="btnBack" type="button" class="top-back-btn">‚Üê Volver al registro</button>

      <div class="card">
        <div class="summary-title">Resumen de hoy</div>

        <div class="summary-row">
          <span>Calor√≠as totales:</span>
          <span id="totalCalorias">0</span>
        </div>
        <div class="summary-row">
          <span>Az√∫cares totales (g):</span>
          <span id="totalAzucares">0</span>
        </div>
        <div class="summary-row">
          <span>Grasas totales (g):</span>
          <span id="totalGrasas">0</span>
        </div>
        <div class="summary-row">
          <span>Prote√≠nas totales (g):</span>
          <span id="totalProteinas">0</span>
        </div>

        <div class="section-title">Progreso vs metas</div>

        <div class="goal-row">
          <span>Calor√≠as</span>
          <span id="goalCaloriasLabel">0 / 0</span>
        </div>
        <div class="progress-bar"><div id="barCalorias" class="progress-fill"></div></div>

        <div class="goal-row">
          <span>Az√∫cares (g)</span>
          <span id="goalAzucaresLabel">0 / 0</span>
        </div>
        <div class="progress-bar"><div id="barAzucares" class="progress-fill"></div></div>

        <div class="goal-row">
          <span>Grasas (g)</span>
          <span id="goalGrasasLabel">0 / 0</span>
        </div>
        <div class="progress-bar"><div id="barGrasas" class="progress-fill"></div></div>

        <div class="goal-row">
          <span>Prote√≠nas (g)</span>
          <span id="goalProteinasLabel">0 / 0</span>
        </div>
        <div class="progress-bar"><div id="barProteinas" class="progress-fill"></div></div>

        <p id="adviceText" class="advice-text"></p>

        <div class="section-title">Comidas registradas</div>
        <div id="mealsList" class="meals-list"></div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Utilidades generales ----------
    const LS_MEALS_KEY = "caloriflow_meals_v3";
    const LS_TEMPLATES_KEY = "caloriflow_templates_v3";
    const LS_GOALS_KEY = "caloriflow_goals_v1";

    function todayDateString() {
      const now = new Date();
      return now.toISOString().slice(0, 10); // YYYY-MM-DD
    }

    function normalizeText(str) {
      if (!str) return "";
      return str
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "") // saca tildes
        .replace(/\s+/g, " ")
        .trim();
    }

    function buildMealKey(itemsArray) {
      if (!itemsArray || !itemsArray.length) return "";
      const normalized = itemsArray
        .map((s) => normalizeText(s))
        .filter((s) => s.length > 0)
        .sort(); // orden alfab√©tico para ser m√°s robusto
      return normalized.join(" | ");
    }

    function loadJSON(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        return JSON.parse(raw);
      } catch {
        return fallback;
      }
    }

    function saveJSON(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }

    // ---------- Datos en memoria ----------
    let mealsAll = loadJSON(LS_MEALS_KEY, []); // hist√≥rico de comidas
    let templates = loadJSON(LS_TEMPLATES_KEY, {}); // plantillas aprendidas
    let goals = loadJSON(LS_GOALS_KEY, {
      calorias: 2000,
      azucares_g: 50,
      grasas_g: 60,
      proteinas_g: 70,
    });

    // ---------- Elementos DOM ----------
    const viewRegistro = document.getElementById("view-registro");
    const viewResumen = document.getElementById("view-resumen");

    const tipoComidaSelect = document.getElementById("tipoComida");
    const itemsInput = document.getElementById("itemsInput");
    const gptJsonInput = document.getElementById("gptJsonInput");
    const btnPrompt = document.getElementById("btnPrompt");
    const btnAddMeal = document.getElementById("btnAddMeal");
    const btnResumen = document.getElementById("btnResumen");
    const btnBack = document.getElementById("btnBack");
    const templateHint = document.getElementById("templateHint");

    const totalCaloriasEl = document.getElementById("totalCalorias");
    const totalAzucaresEl = document.getElementById("totalAzucares");
    const totalGrasasEl = document.getElementById("totalGrasas");
    const totalProteinasEl = document.getElementById("totalProteinas");

    const barCalorias = document.getElementById("barCalorias");
    const barAzucares = document.getElementById("barAzucares");
    const barGrasas = document.getElementById("barGrasas");
    const barProteinas = document.getElementById("barProteinas");

    const goalCaloriasLabel = document.getElementById("goalCaloriasLabel");
    const goalAzucaresLabel = document.getElementById("goalAzucaresLabel");
    const goalGrasasLabel = document.getElementById("goalGrasasLabel");
    const goalProteinasLabel = document.getElementById("goalProteinasLabel");

    const adviceText = document.getElementById("adviceText");
    const mealsList = document.getElementById("mealsList");

    // ---------- Plantillas aprendidas ----------
    function updateTemplateSuggestion() {
      const items = getCurrentItemsArray();
      const key = buildMealKey(items);
      if (!key) {
        templateHint.textContent = "";
        return;
      }
      const tpl = templates[key];
      if (tpl) {
        templateHint.textContent =
          "‚úÖ Esta comida ya est√° en tu base. Si dej√°s vac√≠o el JSON se usar√°n estos valores aprendidos.";
      } else {
        templateHint.textContent =
          "‚ÑπÔ∏è Comida nueva para la app. Primero pedile a ChatGPT y guard√° una vez para que quede aprendida.";
      }
    }

    function getCurrentItemsArray() {
      const raw = itemsInput.value.split("\n");
      return raw.map((s) => s.trim()).filter((s) => s.length > 0);
    }

    function saveTemplateForCurrentItems(cal, azu, gra, pro) {
      const items = getCurrentItemsArray();
      const key = buildMealKey(items);
      if (!key) return;

      templates[key] = {
        calorias: cal,
        azucares_g: azu,
        grasas_g: gra,
        proteinas_g: pro,
        updatedAt: new Date().toISOString(),
      };
      saveJSON(LS_TEMPLATES_KEY, templates);
      updateTemplateSuggestion();
    }

    function getTemplateForCurrentItems() {
      const items = getCurrentItemsArray();
      const key = buildMealKey(items);
      if (!key) return null;
      return templates[key] || null;
    }

    // ---------- Manejo de comidas ----------
    function addMealToLog(meal) {
      mealsAll.push(meal);
      saveJSON(LS_MEALS_KEY, mealsAll);
    }

    function deleteMealById(id) {
      mealsAll = mealsAll.filter((m) => m.id !== id);
      saveJSON(LS_MEALS_KEY, mealsAll);
      renderResumen();
    }

    function getMealsForToday() {
      const today = todayDateString();
      return mealsAll.filter(
        (m) => (m.date || m.timestamp?.slice(0, 10)) === today
      );
    }

    // ---------- Vista registro ----------
    btnPrompt.addEventListener("click", () => {
      const tipo = tipoComidaSelect.value;
      const items = itemsInput.value.trim();
      const prompt = `
Eres un nutricionista.

Analiza la siguiente comida COMPLETA y devuelve los valores totales:

Tipo de comida: ${tipo}

√çtems de la comida:
${items || "- (especificar comida aqu√≠)"}

Quiero que estimes para toda la comida en conjunto:
- calor√≠as totales (kcal)
- gramos de az√∫cares
- gramos de grasas
- gramos de prote√≠nas

MUY IMPORTANTE:
- Responde SOLO un JSON v√°lido.
- SIN explicaciones, SIN comentarios, SIN texto antes o despu√©s.
- NO uses bloques de c√≥digo.

Formato exacto:
{"calorias": 0, "azucares_g": 0, "grasas_g": 0, "proteinas_g": 0}

Rellena los valores con n√∫meros (pueden ser decimales).`.trim();

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard
          .writeText(prompt)
          .then(() => alert("Prompt copiado. P√©galo en ChatGPT."));
      } else {
        alert(
          "Tu navegador no permite copiar autom√°tico. Copia este prompt:\n\n" +
            prompt
        );
      }
    });

    itemsInput.addEventListener("input", updateTemplateSuggestion);

    btnAddMeal.addEventListener("click", () => {
      const tipo = tipoComidaSelect.value;
      const itemsArray = getCurrentItemsArray();
      if (!itemsArray.length) {
        alert("Escribe al menos una l√≠nea con lo que comiste.");
        return;
      }

      const jsonText = gptJsonInput.value.trim();
      let datos = null;

      if (jsonText) {
        // Usamos el JSON pegado y actualizamos la base
        try {
          const parsed = JSON.parse(jsonText);
          const cal = Number(parsed.calorias) || 0;
          const azu = Number(parsed.azucares_g) || 0;
          const gra = Number(parsed.grasas_g) || 0;
          const pro = Number(parsed.proteinas_g) || 0;

          datos = { calorias: cal, azucares_g: azu, grasas_g: gra, proteinas_g: pro };

          // Guardamos lo aprendido para esta descripci√≥n
          saveTemplateForCurrentItems(cal, azu, gra, pro);
        } catch (e) {
          alert("El JSON de ChatGPT no es v√°lido. Rev√≠salo.");
          return;
        }
      } else {
        // No hay JSON -> intentamos usar lo aprendido
        const tpl = getTemplateForCurrentItems();
        if (!tpl) {
          alert(
            "Esta comida todav√≠a no est√° en la base de la app.\nPrimero pedile a ChatGPT, pega el JSON y guarda una vez."
          );
          return;
        }
        datos = {
          calorias: Number(tpl.calorias) || 0,
          azucares_g: Number(tpl.azucares_g) || 0,
          grasas_g: Number(tpl.grasas_g) || 0,
          proteinas_g: Number(tpl.proteinas_g) || 0,
        };
      }

      const now = new Date();
      const meal = {
        id: "m_" + now.getTime() + "_" + Math.random().toString(36).slice(2, 7),
        date: todayDateString(),
        timestamp: now.toISOString(),
        tipo,
        descripcion: itemsArray.join(" ¬∑ "),
        ...datos,
      };

      addMealToLog(meal);
      resetRegistroInputs();
      alert("Comida guardada.");
    });

    function resetRegistroInputs() {
      // No tocamos el tipo de comida para que quede como estaba
      gptJsonInput.value = "";
      // itemsInput.value = "";  // si quer√©s que tambi√©n se limpie, descoment√°
      updateTemplateSuggestion();
    }

    btnResumen.addEventListener("click", () => {
      showView("resumen");
    });

    btnBack.addEventListener("click", () => {
      showView("registro");
    });

    // ---------- Navegaci√≥n entre vistas ----------
    function showView(name) {
      if (name === "registro") {
        viewRegistro.classList.add("active");
        viewResumen.classList.remove("active");
      } else {
        viewRegistro.classList.remove("active");
        viewResumen.classList.add("active");
        renderResumen();
      }
    }

    // ---------- Render del resumen ----------
    function renderResumen() {
      const mealsToday = getMealsForToday();

      let tCal = 0,
        tAz = 0,
        tGr = 0,
        tPr = 0;

      mealsToday.forEach((m) => {
        tCal += m.calorias || 0;
        tAz += m.azucares_g || 0;
        tGr += m.grasas_g || 0;
        tPr += m.proteinas_g || 0;
      });

      totalCaloriasEl.textContent = tCal.toFixed(1);
      totalAzucaresEl.textContent = tAz.toFixed(1);
      totalGrasasEl.textContent = tGr.toFixed(1);
      totalProteinasEl.textContent = tPr.toFixed(1);

      // metas
      goalCaloriasLabel.textContent = `${tCal.toFixed(1)} / ${goals.calorias}`;
      goalAzucaresLabel.textContent = `${tAz.toFixed(1)} / ${goals.azucares_g}`;
      goalGrasasLabel.textContent = `${tGr.toFixed(1)} / ${goals.grasas_g}`;
      goalProteinasLabel.textContent = `${tPr.toFixed(1)} / ${goals.proteinas_g}`;

      function pct(v, goal) {
        if (!goal) return 0;
        return Math.max(0, Math.min(100, (v / goal) * 100));
      }

      barCalorias.style.width = pct(tCal, goals.calorias) + "%";
      barAzucares.style.width = pct(tAz, goals.azucares_g) + "%";
      barGrasas.style.width = pct(tGr, goals.grasas_g) + "%";
      barProteinas.style.width = pct(tPr, goals.proteinas_g) + "%";

      // mensajito simple
      if (tCal < goals.calorias * 0.4) {
        adviceText.textContent =
          "Vas por debajo de la mitad de tu meta de calor√≠as. Asegurate de no saltearte comidas importantes.";
      } else if (tCal > goals.calorias * 1.1) {
        adviceText.textContent =
          "Est√°s por encima de tu meta cal√≥rica diaria. Quiz√°s conviene moderar las pr√≥ximas comidas.";
      } else {
        adviceText.textContent =
          "Vas bastante alineado con tu meta cal√≥rica. Segu√≠ registrando para afinar los n√∫meros.";
      }

      // listado de comidas
      mealsList.innerHTML = "";
      if (!mealsToday.length) {
        mealsList.innerHTML =
          '<p style="font-size:0.86rem;color:#9ca3af;">Todav√≠a no registraste comidas hoy.</p>';
        return;
      }

      for (const m of mealsToday) {
        const div = document.createElement("div");
        div.className = "meal-item";

        const hora = new Date(m.timestamp).toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });

        div.innerHTML = `
          <div class="meal-header-row">
            <strong>${m.tipo}</strong>
            <span class="meal-time">${hora}</span>
          </div>
          <div class="meal-desc">- ${m.descripcion}</div>
          <div class="meal-macros">
            ${m.calorias.toFixed(1)} kcal ¬∑
            ${m.proteinas_g.toFixed(1)} g prot ¬∑
            ${m.grasas_g.toFixed(1)} g grasa ¬∑
            ${m.azucares_g.toFixed(1)} g az√∫car
          </div>
          <div style="margin-top:4px;">
            <button type="button" class="btn-delete" data-id="${m.id}">
              <span>üóë</span> Eliminar
            </button>
          </div>
        `;
        mealsList.appendChild(div);
      }

      // handler de eliminaci√≥n
      mealsList.querySelectorAll(".btn-delete").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          if (confirm("¬øEliminar esta comida del resumen de hoy?")) {
            deleteMealById(id);
          }
        });
      });
    }

    // ---------- Init ----------
    updateTemplateSuggestion();
  </script>
</body>
</html>