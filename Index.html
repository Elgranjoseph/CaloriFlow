<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CaloriFlow ¬∑ Registro diario</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-main: #050712;
      --bg-card: #0d1020;
      --bg-soft: #15182b;
      --accent: #e14bff;
      --accent-2: #7b5cff;
      --danger: #ff4b6a;
      --text-main: #f7f7ff;
      --text-muted: #b3b7d0;
      --border-soft: #26283d;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top left, #261d4a 0, #050712 45%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 480px;
      padding: 20px 16px 32px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    h1 {
      margin: 0;
      font-size: 26px;
    }

    .subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .card {
      background: radial-gradient(circle at top left, #1c1f3c, #050816 65%);
      border-radius: 20px;
      padding: 16px 14px;
      margin-top: 16px;
      border: 1px solid rgba(148, 163, 255, 0.25);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.85);
    }

    .card h2 {
      margin: 0 0 4px;
      font-size: 18px;
    }

    .card p {
      margin: 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    label {
      display: block;
      font-size: 13px;
      margin-top: 10px;
      margin-bottom: 4px;
      color: var(--text-muted);
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: rgba(6, 9, 24, 0.95);
      color: var(--text-main);
      font-size: 14px;
      padding: 9px 11px;
      outline: none;
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent-2);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.6);
    }

    .small-helper {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 3px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-2), var(--accent));
      color: #12071f;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.9);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      border: 1px solid var(--border-soft);
    }

    .btn-small {
      padding: 6px 10px;
      font-size: 12px;
    }

    .top-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    #btnSummary {
      padding: 10px 18px;
      font-size: 14px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      border: none;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.9);
    }

    .portion-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }

    .portion-row input[type="number"] {
      width: 35%;
    }

    .portion-row select {
      width: 65%;
    }

    .items-list {
      margin-top: 8px;
      font-size: 13px;
    }

    .items-list-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid rgba(148, 163, 255, 0.15);
    }

    .items-list-row span {
      flex: 1;
      margin-right: 8px;
    }

    .items-list-row button {
      border-radius: 999px;
      border: none;
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
      background: rgba(239, 68, 68, 0.15);
      color: #fecaca;
    }

    /* Overlay resumen */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(3, 7, 18, 0.95);
      display: none;
      justify-content: center;
      align-items: flex-start;
      padding: 18px 12px 28px;
      z-index: 20;
    }

    .overlay-inner {
      width: 100%;
      max-width: 480px;
      background: radial-gradient(circle at top left, #1c1f3c, #050816 65%);
      border-radius: 22px;
      padding: 16px 14px 20px;
      border: 1px solid rgba(148, 163, 255, 0.3);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.95);
      max-height: 100%;
      overflow-y: auto;
    }

    .overlay-back {
      width: 100%;
      display: flex;
      justify-content: flex-start;
      margin-bottom: 8px;
    }

    .overlay-back .btn {
      width: auto;
      padding-inline: 14px;
      font-size: 13px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-top: 6px;
    }

    .summary-section-title {
      margin-top: 14px;
      font-size: 15px;
    }

    .meal-item {
      border-top: 1px solid rgba(148, 163, 255, 0.2);
      padding-top: 6px;
      margin-top: 6px;
      font-size: 13px;
    }

    .meal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .meal-header-left {
      flex: 1;
    }

    .meal-delete-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      background: rgba(239, 68, 68, 0.15);
      color: #fecaca;
      white-space: nowrap;
    }

    .meal-item strong {
      font-size: 13px;
    }

    #btnOpenChatGPT,
    #btnSaveMeal {
      width: 100%;
      margin-top: 12px;
      font-size: 15px;
      padding: 12px 18px;
    }

    .status {
      margin-top: 8px;
      font-size: 13px;
      min-height: 18px;
      color: var(--text-muted);
    }

    /* Metas y progreso */
    .progress-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-top: 4px;
    }

    .progress-bar {
      margin-top: 4px;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      width: 0%;
      transition: width 0.2s ease-out;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      margin-top: 6px;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <h1>CaloriFlow</h1>
      <div class="subtitle">Registro diario r√°pido y simple.</div>
    </div>
    <div class="top-actions">
      <button class="btn" id="btnSummary">
        üìä Ver resumen
      </button>
    </div>
  </header>

  <!-- NUEVA COMIDA -->
  <div class="card">
    <h2>Nueva comida</h2>

    <label for="mealType">Tipo</label>
    <select id="mealType">
      <option value="Desayuno">Desayuno</option>
      <option value="Almuerzo">Almuerzo</option>
      <option value="Merienda">Merienda</option>
      <option value="Cena">Cena</option>
      <option value="Snack">Snack</option>
    </select>

    <label>√çtem de la comida</label>
    <div class="portion-row">
      <input
        type="number"
        id="itemAmount"
        min="0"
        step="0.5"
        placeholder="Ej: 1"
      />
      <select id="itemUnit">
        <option value="ninguna">(sin unidad)</option>
        <option value="porci√≥n">porci√≥n</option>
        <option value="taza">taza</option>
        <option value="plato">plato</option>
        <option value="vaso">vaso</option>
        <option value="unidad">unidad</option>
      </select>
    </div>
    <textarea
      id="itemDescription"
      placeholder="Ej: caf√© con leche, jugo, tostada con mermelada"
    ></textarea>
    <div class="small-helper">
      Pod√©s sumar varios √≠tems a la misma comida.
    </div>

    <button class="btn btn-secondary" id="btnAddItem">
      ‚ûï Agregar √≠tem
    </button>

    <div class="items-list" id="itemsList"></div>

    <div id="templateSuggestion" class="small-helper"></div>

    <button class="btn btn-primary" id="btnOpenChatGPT">
      üí¨ Preguntar a ChatGPT
    </button>
  </div>

  <!-- RESULTADO CHATGPT + GUARDAR -->
  <div class="card">
    <h2>Datos de la comida</h2>
    <p class="small-helper">
      Peg√° el resultado de ChatGPT (el JSON) o, si ya registraste esta misma comida antes, pod√©s guardar sin pegar nada.
    </p>

    <label for="jsonChatGPT" style="margin-top:10px;">Resultado de ChatGPT (opcional)</label>
    <textarea
      id="jsonChatGPT"
      placeholder='Peg√° aqu√≠ el resultado de ChatGPT con el formato {"calorias": ..., "azucares_g": ..., "grasas_g": ..., "proteinas_g": ...}'
    ></textarea>

    <button class="btn btn-primary" id="btnSaveMeal">
      ‚úÖ Agregar comida
    </button>

    <div class="status" id="saveStatus"></div>
  </div>

  <!-- METAS DIARIAS -->
  <div class="card">
    <h2>Metas diarias</h2>
    <p class="small-helper">
      Pod√©s usar lo que te sugiera tu nutricionista o una IA y guardarlo ac√°.
    </p>
    <div class="portion-row">
      <div style="flex:1;">
        <label for="goalCal">Calor√≠as (kcal)</label>
        <input type="number" id="goalCal" placeholder="Ej: 2000" />
      </div>
      <div style="flex:1;">
        <label for="goalProt">Prote√≠nas (g)</label>
        <input type="number" id="goalProt" placeholder="Ej: 70" />
      </div>
    </div>
    <div class="portion-row">
      <div style="flex:1;">
        <label for="goalFat">Grasas (g)</label>
        <input type="number" id="goalFat" placeholder="Ej: 60" />
      </div>
      <div style="flex:1;">
        <label for="goalSugar">Az√∫cares (g)</label>
        <input type="number" id="goalSugar" placeholder="Ej: 50" />
      </div>
    </div>

    <button class="btn btn-secondary" id="btnSaveGoals" style="margin-top:10px;">
      üíæ Guardar metas
    </button>
    <div class="small-helper" id="goalsStatus"></div>
  </div>

  <!-- RECORDATORIO DE COMIDAS -->
  <div class="card">
    <h2>Recordatorio de comidas</h2>
    <div class="toggle-row">
      <input type="checkbox" id="reminderEnabled" />
      <span>Activar recordatorio si pasa mucho tiempo sin registrar comidas.</span>
    </div>

    <label for="reminderInterval">Tiempo m√°ximo sin registrar comida</label>
    <select id="reminderInterval">
      <option value="120">2 horas</option>
      <option value="180">3 horas</option>
      <option value="240">4 horas</option>
    </select>

    <div class="small-helper">
      El recordatorio funciona mientras la app est√© abierta o activa.
    </div>
  </div>
</div>

<!-- OVERLAY RESUMEN -->
<div class="overlay" id="summaryOverlay">
  <div class="overlay-inner">
    <div class="overlay-back">
      <button class="btn btn-secondary btn-small" id="btnCloseSummary">
        ‚Üê Volver al registro
      </button>
    </div>

    <h2 style="margin:4px 0 4px;">Resumen de hoy</h2>

    <div id="summary">
      <div class="summary-row">
        <span>Calor√≠as totales:</span>
        <strong id="sumCal">0</strong>
      </div>
      <div class="summary-row">
        <span>Az√∫cares totales (g):</span>
        <strong id="sumSugar">0</strong>
      </div>
      <div class="summary-row">
        <span>Grasas totales (g):</span>
        <strong id="sumFat">0</strong>
      </div>
      <div class="summary-row">
        <span>Prote√≠nas totales (g):</span>
        <strong id="sumProtein">0</strong>
      </div>
    </div>

    <h3 class="summary-section-title">Progreso vs metas</h3>
    <div class="progress-row">
      <span>Calor√≠as</span>
      <span id="progressCalText">0 / 0</span>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progressCalBar"></div></div>

    <div class="progress-row">
      <span>Az√∫cares (g)</span>
      <span id="progressSugarText">0 / 0</span>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progressSugarBar"></div></div>

    <div class="progress-row">
      <span>Grasas (g)</span>
      <span id="progressFatText">0 / 0</span>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progressFatBar"></div></div>

    <div class="progress-row">
      <span>Prote√≠nas (g)</span>
      <span id="progressProtText">0 / 0</span>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progressProtBar"></div></div>

    <div class="small-helper" id="progressNote" style="margin-top:8px;"></div>

    <h3 class="summary-section-title">Comidas registradas</h3>
    <div id="mealsList">
      <span class="small-helper">Todav√≠a no hay registros hoy.</span>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = "caloriflow_meals_v2";
  const TEMPLATES_KEY = "caloriflow_templates_v2";
  const GOALS_KEY = "caloriflow_goals_v1";
  const REMINDER_KEY = "caloriflow_reminder_v1";

  let currentItems = [];
  let reminderTimer = null;
  let lastMealTime = Date.now();

  const itemAmountEl = document.getElementById("itemAmount");
  const itemUnitEl = document.getElementById("itemUnit");
  const itemDescriptionEl = document.getElementById("itemDescription");
  const itemsListEl = document.getElementById("itemsList");
  const templateSuggestionEl = document.getElementById("templateSuggestion");

  const summaryOverlay = document.getElementById("summaryOverlay");
  const btnSummary = document.getElementById("btnSummary");
  const btnCloseSummary = document.getElementById("btnCloseSummary");

  const goalCalEl = document.getElementById("goalCal");
  const goalProtEl = document.getElementById("goalProt");
  const goalFatEl = document.getElementById("goalFat");
  const goalSugarEl = document.getElementById("goalSugar");
  const goalsStatusEl = document.getElementById("goalsStatus");

  const reminderEnabledEl = document.getElementById("reminderEnabled");
  const reminderIntervalEl = document.getElementById("reminderInterval");

  function normalizeString(str) {
    return str
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ")
      .trim();
  }

  function formatItemText(item) {
    const amount = item.amount || "1";
    const unit = item.unit && item.unit !== "ninguna" ? ` ${item.unit}` : "";
    const base = item.description || "";
    if (!base) return "";
    if (item.unit === "ninguna") {
      return `${amount} ${base}`.trim();
    }
    return `${amount}${unit} de ${base}`.trim();
  }

  function buildMealKey(items) {
    if (!items.length) return "";
    const combined = items
      .map(i => formatItemText(i))
      .filter(Boolean)
      .join(" | ");
    return normalizeString(combined);
  }

  function renderItemsList() {
    itemsListEl.innerHTML = "";

    if (currentItems.length === 0) {
      return;
    }

    currentItems.forEach((item, index) => {
      const row = document.createElement("div");
      row.className = "items-list-row";

      const span = document.createElement("span");
      span.textContent = formatItemText(item);

      const btnDel = document.createElement("button");
      btnDel.textContent = "‚ùå";
      btnDel.title = "Quitar √≠tem";
      btnDel.onclick = () => {
        currentItems.splice(index, 1);
        renderItemsList();
        updateTemplateSuggestion();
      };

      row.appendChild(span);
      row.appendChild(btnDel);
      itemsListEl.appendChild(row);
    });

    updateTemplateSuggestion();
  }

  function addItem() {
    const amount = itemAmountEl.value.trim();
    const unit = itemUnitEl.value;
    const description = itemDescriptionEl.value.trim();

    if (!description) {
      alert("Escrib√≠ la descripci√≥n del √≠tem (ej: tostada con mermelada).");
      return;
    }

    const item = {
      amount: amount || "1",
      unit,
      description
    };

    currentItems.push(item);
    itemAmountEl.value = "";
    itemDescriptionEl.value = "";

    renderItemsList();
  }

  function loadTemplates() {
    try {
      const raw = localStorage.getItem(TEMPLATES_KEY);
      return raw ? JSON.parse(raw) : {};
    } catch (e) {
      console.warn("Error leyendo templates:", e);
      return {};
    }
  }

  function saveTemplates(obj) {
    try {
      localStorage.setItem(TEMPLATES_KEY, JSON.stringify(obj));
    } catch (e) {
      console.warn("Error guardando templates:", e);
    }
  }

  function getTemplateForCurrentItems() {
    const key = buildMealKey(currentItems);
    if (!key) return null;
    const templates = loadTemplates();
    return templates[key] || null;
  }

  function updateTemplateSuggestion() {
    if (!currentItems.length) {
      templateSuggestionEl.textContent = "";
      return;
    }
    const t = getTemplateForCurrentItems();
    if (t) {
      templateSuggestionEl.textContent =
        "Esta comida ya est√° aprendida. Si no peg√°s nada de ChatGPT, se usar√°n estos valores autom√°ticamente.";
    } else {
      templateSuggestionEl.textContent =
        "Primera vez con esta combinaci√≥n. Pod√©s usar ChatGPT para estimar los datos.";
    }
  }

  function buildPrompt() {
    const mealType = document.getElementById("mealType").value;
    if (currentItems.length === 0) {
      alert("Primero agreg√° al menos un √≠tem.");
      return null;
    }

    const lines = currentItems
      .map((item, idx) => `${idx + 1}. ${formatItemText(item)}`)
      .filter(Boolean);

    const itemsText = lines.join("\n");

    const prompt = `
Eres un nutricionista.

Analiza la siguiente comida COMPLETA y devuelve los valores totales:

Tipo de comida: ${mealType}

√çtems de la comida:
${itemsText}

Quiero que estimes para toda la comida en conjunto:
- calor√≠as totales (kcal)
- gramos de az√∫cares
- gramos de grasas
- gramos de prote√≠nas

MUY IMPORTANTE:
- Responde SOLO un JSON v√°lido.
- SIN explicaciones, SIN comentarios, SIN texto antes o despu√©s.
- NO uses bloques de c√≥digo ni \`\`\`.
- Escribe el JSON en UNA SOLA L√çNEA.

Formato exacto:
{"calorias": 0, "azucares_g": 0, "grasas_g": 0, "proteinas_g": 0}

Rellena los valores con n√∫meros (pueden ser decimales).
`;
    return prompt.trim();
  }

  function openChatGPT() {
    const prompt = buildPrompt();
    if (!prompt) return;
    const url = "https://chat.openai.com/?q=" + encodeURIComponent(prompt);
    window.open(url, "_blank");
  }

  // Intenta parsear el JSON pegado. Devuelve objeto {calorias, azucares_g, grasas_g, proteinas_g} o null.
  function parseFromJsonOrNull() {
    const jsonText = document.getElementById("jsonChatGPT").value.trim();
    if (!jsonText) return null;

    let raw = jsonText;
    const match = raw.match(/\{[\s\S]*\}/);
    if (match) raw = match[0];

    try {
      const data = JSON.parse(raw);
      return {
        calorias: Number(data.calorias || 0),
        azucares_g: Number(data.azucares_g || 0),
        grasas_g: Number(data.grasas_g || 0),
        proteinas_g: Number(data.proteinas_g || 0)
      };
    } catch (e) {
      console.warn("JSON inv√°lido:", e);
      return null;
    }
  }

  function loadGoals() {
    try {
      const raw = localStorage.getItem(GOALS_KEY);
      if (!raw) {
        return { cal: 2000, prot: 70, fat: 60, sugar: 50 };
      }
      const obj = JSON.parse(raw);
      return {
        cal: Number(obj.cal || 0),
        prot: Number(obj.prot || 0),
        fat: Number(obj.fat || 0),
        sugar: Number(obj.sugar || 0)
      };
    } catch (e) {
      console.warn("Error leyendo metas:", e);
      return { cal: 2000, prot: 70, fat: 60, sugar: 50 };
    }
  }

  function saveGoals(goals) {
    try {
      localStorage.setItem(GOALS_KEY, JSON.stringify(goals));
    } catch (e) {
      console.warn("Error guardando metas:", e);
    }
  }

  function renderGoalsUI() {
    const g = loadGoals();
    goalCalEl.value = g.cal || "";
    goalProtEl.value = g.prot || "";
    goalFatEl.value = g.fat || "";
    goalSugarEl.value = g.sugar || "";
  }

  function saveGoalsFromUI() {
    const cal = Number(goalCalEl.value || 0);
    const prot = Number(goalProtEl.value || 0);
    const fat = Number(goalFatEl.value || 0);
    const sugar = Number(goalSugarEl.value || 0);

    const goals = { cal, prot, fat, sugar };
    saveGoals(goals);
    goalsStatusEl.textContent = "Metas guardadas.";
    goalsStatusEl.style.color = "#4ade80";

    setTimeout(() => {
      goalsStatusEl.textContent = "";
    }, 2000);
  }

  function setProgressBar(barEl, value, goal) {
    if (!barEl) return;
    if (!goal || goal <= 0) {
      barEl.style.width = "0%";
      return;
    }
    let pct = (value / goal) * 100;
    if (pct > 150) pct = 150;
    barEl.style.width = pct + "%";
  }

  function loadMeals() {
    let all = [];
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) all = JSON.parse(raw);
    } catch (e) {
      console.warn("Error leyendo meals:", e);
    }

    const today = new Date();
    const todayStr = today.toISOString().slice(0, 10);

    const list = document.getElementById("mealsList");
    list.innerHTML = "";

    let todaysMeals = [];
    let totals = { cal: 0, sugar: 0, fat: 0, prot: 0 };

    all.forEach((m, idx) => {
      if (!m.date) return;
      if (!m.date.startsWith(todayStr)) return;

      todaysMeals.push({ meal: m, index: idx });

      totals.cal += m.calorias || 0;
      totals.sugar += m.azucares_g || 0;
      totals.fat += m.grasas_g || 0;
      totals.prot += m.proteinas_g || 0;
    });

    document.getElementById("sumCal").textContent = totals.cal.toFixed(1);
    document.getElementById("sumSugar").textContent = totals.sugar.toFixed(1);
    document.getElementById("sumFat").textContent = totals.fat.toFixed(1);
    document.getElementById("sumProtein").textContent = totals.prot.toFixed(1);

    const goals = loadGoals();

    const progressCalText = document.getElementById("progressCalText");
    const progressSugarText = document.getElementById("progressSugarText");
    const progressFatText = document.getElementById("progressFatText");
    const progressProtText = document.getElementById("progressProtText");

    progressCalText.textContent = `${totals.cal.toFixed(1)} / ${goals.cal || 0}`;
    progressSugarText.textContent = `${totals.sugar.toFixed(1)} / ${goals.sugar || 0}`;
    progressFatText.textContent = `${totals.fat.toFixed(1)} / ${goals.fat || 0}`;
    progressProtText.textContent = `${totals.prot.toFixed(1)} / ${goals.prot || 0}`;

    setProgressBar(document.getElementById("progressCalBar"), totals.cal, goals.cal);
    setProgressBar(document.getElementById("progressSugarBar"), totals.sugar, goals.sugar);
    setProgressBar(document.getElementById("progressFatBar"), totals.fat, goals.fat);
    setProgressBar(document.getElementById("progressProtBar"), totals.prot, goals.prot);

    const noteEl = document.getElementById("progressNote");
    if (goals.cal && totals.cal > goals.cal * 1.1) {
      noteEl.textContent = "Parece que ya superaste tu meta de calor√≠as para hoy. Revis√° si quer√©s ajustar comidas posteriores.";
    } else if (goals.cal && totals.cal < goals.cal * 0.5) {
      noteEl.textContent = "Vas por debajo de la mitad de tu meta de calor√≠as. Asegurate de no saltearte comidas importantes.";
    } else {
      noteEl.textContent = "";
    }

    if (todaysMeals.length === 0) {
      list.innerHTML = '<span class="small-helper">Todav√≠a no hay registros hoy.</span>';
      return;
    }

    todaysMeals.forEach(({ meal, index }) => {
      const div = document.createElement("div");
      div.className = "meal-item";

      const itemsHtml = (meal.items || [])
        .map(i => "- " + formatItemText(i))
        .join("<br/>");

      const header = document.createElement("div");
      header.className = "meal-header";

      const left = document.createElement("div");
      left.className = "meal-header-left";
      left.innerHTML = `
        <strong>${meal.tipo}</strong> ¬∑ ${new Date(meal.date).toLocaleTimeString()}
      `;

      const btnDel = document.createElement("button");
      btnDel.className = "meal-delete-btn";
      btnDel.textContent = "üóë Eliminar";
      btnDel.onclick = () => deleteMeal(index);

      header.appendChild(left);
      header.appendChild(btnDel);

      const body = document.createElement("div");
      body.innerHTML = `
        <div style="margin-top:4px;">${itemsHtml || ""}</div>
        <span class="small-helper">
          ${meal.calorias?.toFixed?.(1) || meal.calorias || 0} kcal ¬∑
          ${meal.proteinas_g?.toFixed?.(1) || meal.proteinas_g || 0} g prot ¬∑
          ${meal.grasas_g?.toFixed?.(1) || meal.grasas_g || 0} g grasa ¬∑
          ${meal.azucares_g?.toFixed?.(1) || meal.azucares_g || 0} g az√∫car
        </span>
      `;

      div.appendChild(header);
      div.appendChild(body);
      list.appendChild(div);
    });
  }

  function deleteMeal(globalIndex) {
    let all = [];
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) all = JSON.parse(raw);
    } catch (e) {
      console.warn("Error leyendo meals para borrar:", e);
    }

    if (globalIndex < 0 || globalIndex >= all.length) return;

    all.splice(globalIndex, 1);

    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(all));
    } catch (e) {
      console.warn("Error guardando meals tras borrar:", e);
    }

    loadMeals();
  }

  function saveTemplateForCurrentItems(cal, azu, gra, pro) {
    const key = buildMealKey(currentItems);
    if (!key) return;

    const templates = loadTemplates();
    const existing = templates[key];

    if (!existing) {
      templates[key] = {
        calorias: cal,
        azucares_g: azu,
        grasas_g: gra,
        proteinas_g: pro,
        count: 1
      };
    } else {
      const n = (existing.count || 1) + 1;
      existing.calorias = ((existing.calorias || 0) * (n - 1) + cal) / n;
      existing.azucares_g = ((existing.azucares_g || 0) * (n - 1) + azu) / n;
      existing.grasas_g = ((existing.grasas_g || 0) * (n - 1) + gra) / n;
      existing.proteinas_g = ((existing.proteinas_g || 0) * (n - 1) + pro) / n;
      existing.count = n;
      templates[key] = existing;
    }

    saveTemplates(templates);
    updateTemplateSuggestion();
  }

  function resetMealForm() {
    currentItems = [];
    renderItemsList();
    document.getElementById("jsonChatGPT").value = "";
    templateSuggestionEl.textContent = "";
  }

  function saveMeal() {
    const mealType = document.getElementById("mealType").value;
    const status = document.getElementById("saveStatus");

    if (currentItems.length === 0) {
      status.textContent = "Agreg√° al menos un √≠tem.";
      status.style.color = "var(--danger)";
      return;
    }

    let parsed = parseFromJsonOrNull();
    let cal = 0, azu = 0, gra = 0, pro = 0;

    if (parsed) {
      cal = parsed.calorias;
      azu = parsed.azucares_g;
      gra = parsed.grasas_g;
      pro = parsed.proteinas_g;
    } else {
      const t = getTemplateForCurrentItems();
      if (t) {
        cal = t.calorias || 0;
        azu = t.azucares_g || 0;
        gra = t.grasas_g || 0;
        pro = t.proteinas_g || 0;
      }
    }

    if (!cal && !azu && !gra && !pro) {
      status.textContent = "Peg√° el resultado de ChatGPT o us√° una comida ya aprendida.";
      status.style.color = "var(--danger)";
      return;
    }

    let all = [];
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) all = JSON.parse(raw);
    } catch (e) {
      console.warn("No se pudo leer el storage:", e);
    }

    const meal = {
      tipo: mealType,
      items: currentItems.slice(),
      calorias: cal,
      azucares_g: azu,
      grasas_g: gra,
      proteinas_g: pro,
      date: new Date().toISOString()
    };

    all.push(meal);

    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(all));
      status.textContent = "Comida guardada.";
      status.style.color = "#4ade80";

      saveTemplateForCurrentItems(cal, azu, gra, pro);
      loadMeals();
      resetMealForm();

      lastMealTime = Date.now();
    } catch (e) {
      status.textContent = "No se pudo guardar (revis√° espacio/permisos).";
      status.style.color = "var(--danger)";
    }
  }

  function loadReminderSettings() {
    try {
      const raw = localStorage.getItem(REMINDER_KEY);
      if (!raw) return { enabled: false, intervalMinutes: 180 };
      const obj = JSON.parse(raw);
      return {
        enabled: !!obj.enabled,
        intervalMinutes: Number(obj.intervalMinutes || 180)
      };
    } catch (e) {
      console.warn("Error leyendo recordatorio:", e);
      return { enabled: false, intervalMinutes: 180 };
    }
  }

  function saveReminderSettings(settings) {
    try {
      localStorage.setItem(REMINDER_KEY, JSON.stringify(settings));
    } catch (e) {
      console.warn("Error guardando recordatorio:", e);
    }
  }

  function setupReminderTimer() {
    const settings = loadReminderSettings();

    if (reminderTimer) {
      clearInterval(reminderTimer);
      reminderTimer = null;
    }

    if (!settings.enabled) return;

    const intervalMs = 60 * 1000; // chequeo cada 1 minuto
    reminderTimer = setInterval(() => {
      const now = Date.now();
      const diffMinutes = (now - lastMealTime) / (60 * 1000);
      if (diffMinutes >= settings.intervalMinutes) {
        alert("Recordatorio: revis√° si comiste o registraste tu comida/colaci√≥n.");
        lastMealTime = Date.now();
      }
    }, intervalMs);
  }

  function initReminderUI() {
    const settings = loadReminderSettings();
    reminderEnabledEl.checked = settings.enabled;
    reminderIntervalEl.value = String(settings.intervalMinutes);
    setupReminderTimer();
  }

  btnSummary.addEventListener("click", () => {
    loadMeals();
    summaryOverlay.style.display = "flex";
  });

  btnCloseSummary.addEventListener("click", () => {
    summaryOverlay.style.display = "none";
  });

  document.getElementById("btnAddItem").addEventListener("click", addItem);
  document.getElementById("btnOpenChatGPT").addEventListener("click", openChatGPT);
  document.getElementById("btnSaveMeal").addEventListener("click", saveMeal);
  document.getElementById("btnSaveGoals").addEventListener("click", saveGoalsFromUI);

  reminderEnabledEl.addEventListener("change", () => {
    const settings = {
      enabled: reminderEnabledEl.checked,
      intervalMinutes: Number(reminderIntervalEl.value || 180)
    };
    saveReminderSettings(settings);
    setupReminderTimer();
  });

  reminderIntervalEl.addEventListener("change", () => {
    const settings = {
      enabled: reminderEnabledEl.checked,
      intervalMinutes: Number(reminderIntervalEl.value || 180)
    };
    saveReminderSettings(settings);
    setupReminderTimer();
  });

  renderGoalsUI();
  initReminderUI();
  loadMeals();
  renderItemsList();
</script>
</body>
</html>