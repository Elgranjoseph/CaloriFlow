<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CaloriFlow ¬∑ Registro diario</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-main: #050712;
      --bg-card: #0d1020;
      --bg-soft: #15182b;
      --accent: #e14bff;
      --accent-2: #7b5cff;
      --danger: #ff4b6a;
      --text-main: #f7f7ff;
      --text-muted: #b3b7d0;
      --border-soft: #26283d;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top left, #261d4a 0, #050712 45%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 480px;
      padding: 20px 16px 32px;
    }

    h1 {
      margin: 0;
      font-size: 26px;
    }

    .subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .card {
      background: radial-gradient(circle at top left, #1c1f3c, #050816 65%);
      border-radius: 20px;
      padding: 16px 14px;
      margin-top: 16px;
      border: 1px solid rgba(148, 163, 255, 0.25);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.85);
    }

    .card h2 {
      margin: 0 0 4px;
      font-size: 18px;
    }

    .card p {
      margin: 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    label {
      display: block;
      font-size: 13px;
      margin-top: 10px;
      margin-bottom: 4px;
      color: var(--text-muted);
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: rgba(6, 9, 24, 0.95);
      color: var(--text-main);
      font-size: 14px;
      padding: 9px 11px;
      outline: none;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent-2);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.6);
    }

    .small-helper {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 3px;
    }

    .btn {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 12px 14px;
      margin-top: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-2), var(--accent));
      color: #12071f;
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.9);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      border: 1px solid var(--border-soft);
    }

    .values-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 255, 0.55);
      background: rgba(8, 12, 32, 0.95);
      margin-top: 8px;
    }

    .status {
      margin-top: 8px;
      font-size: 13px;
      min-height: 18px;
      color: var(--text-muted);
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-top: 6px;
    }

    .meal-item {
      border-top: 1px solid rgba(148, 163, 255, 0.2);
      padding-top: 6px;
      margin-top: 6px;
      font-size: 13px;
    }

    .meal-item strong {
      font-size: 13px;
    }

    #templateSuggestion {
      margin-top: 6px;
    }

    .portion-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }

    .portion-row input[type="number"] {
      width: 35%;
    }

    .portion-row select {
      width: 65%;
    }
  </style>
</head>
<body>
<div class="app">
  <h1>CaloriFlow</h1>
  <div class="subtitle">
    Us√° ChatGPT como cerebro, y la app aprende tus comidas para no repetir consultas.
  </div>

  <!-- Secci√≥n de comida -->
  <div class="card">
    <h2>Nueva comida</h2>
    <p>Describe la comida. La primera vez us√°s ChatGPT, despu√©s la app la aprende.</p>

    <label for="mealType">Tipo de comida</label>
    <select id="mealType">
      <option value="Desayuno">Desayuno</option>
      <option value="Almuerzo">Almuerzo</option>
      <option value="Merienda">Merienda</option>
      <option value="Cena">Cena</option>
      <option value="Snack">Snack</option>
    </select>

    <label for="portionAmount">Cantidad y unidad</label>
    <div class="portion-row">
      <input
        type="number"
        id="portionAmount"
        min="0"
        step="0.5"
        placeholder="Ej: 1"
      />
      <select id="portionUnit">
        <option value="ninguna">(sin unidad)</option>
        <option value="porci√≥n">porci√≥n</option>
        <option value="taza">taza</option>
        <option value="plato">plato</option>
        <option value="vaso">vaso</option>
        <option value="unidad">unidad</option>
      </select>
    </div>
    <div class="small-helper">
      Ej: 1 taza, 1 porci√≥n, 2 unidades, etc.
    </div>

    <label for="mealDescription">¬øQu√© comiste?</label>
    <textarea
      id="mealDescription"
      placeholder="Ej: caf√© con leche, tostadas con mermelada"
    ></textarea>
    <div class="small-helper">
      Cuanto m√°s claro seas (porciones, tama√±o, ingredientes), mejor.
    </div>

    <div id="templateSuggestion" class="small-helper"></div>
    <button class="btn btn-secondary" id="btnUseTemplate" style="display:none;">
      üìÇ Usar valores guardados para esta comida
    </button>

    <button class="btn btn-primary" id="btnOpenChatGPT">
      üí¨ Abrir en ChatGPT con prompt listo
    </button>

    <div class="status">
      Ten√©s que estar logueado en <strong>chat.openai.com</strong>. La app arma el prompt.
    </div>
  </div>

  <!-- Importar JSON devuelto por ChatGPT y guardar -->
  <div class="card">
    <h2>Importar e incorporar comida</h2>
    <p>
      Pedile a ChatGPT que te devuelva <strong>S√ìLO un JSON</strong> con estos
      campos:
    </p>
    <div class="badge">
      {"calorias": 0, "azucares_g": 0, "grasas_g": 0, "proteinas_g": 0}
    </div>

    <label for="jsonChatGPT">Peg√° aqu√≠ el JSON que te devolvi√≥ ChatGPT</label>
    <textarea
      id="jsonChatGPT"
      placeholder='Ej: {"calorias": 320, "azucares_g": 18, "grasas_g": 10, "proteinas_g": 12}'
    ></textarea>

    <button class="btn btn-secondary" id="btnImportJson">
      ‚¨á Importar valores en los campos
    </button>

    <div class="values-grid">
      <div>
        <label for="caloriesInput">Calor√≠as (kcal)</label>
        <input type="number" id="caloriesInput" placeholder="Ej: 320" />
      </div>
      <div>
        <label for="sugarInput">Az√∫cares (g)</label>
        <input type="number" id="sugarInput" placeholder="Ej: 18" />
      </div>
      <div>
        <label for="fatInput">Grasas (g)</label>
        <input type="number" id="fatInput" placeholder="Ej: 10" />
      </div>
      <div>
        <label for="proteinInput">Prote√≠nas (g)</label>
        <input type="number" id="proteinInput" placeholder="Ej: 12" />
      </div>
    </div>

    <button class="btn btn-primary" id="btnSaveMeal">
      ‚úÖ Guardar comida en el registro
    </button>

    <div class="status" id="saveStatus"></div>
  </div>

  <!-- Resumen diario -->
  <div class="card">
    <h2>Resumen de hoy</h2>
    <div id="summary">
      <div class="summary-row">
        <span>Calor√≠as totales:</span>
        <strong id="sumCal">0</strong>
      </div>
      <div class="summary-row">
        <span>Az√∫cares totales (g):</span>
        <strong id="sumSugar">0</strong>
      </div>
      <div class="summary-row">
        <span>Grasas totales (g):</span>
        <strong id="sumFat">0</strong>
      </div>
      <div class="summary-row">
        <span>Prote√≠nas totales (g):</span>
        <strong id="sumProtein">0</strong>
      </div>
    </div>

    <h3 style="margin-top:14px;font-size:15px;">Comidas de hoy</h3>
    <div id="mealsList">
      <span class="small-helper">Todav√≠a no hay registros hoy.</span>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = "caloriflow_meals_v1";
  const TEMPLATES_KEY = "caloriflow_templates_v1";

  const mealDescriptionEl = document.getElementById("mealDescription");
  const portionAmountEl = document.getElementById("portionAmount");
  const portionUnitEl = document.getElementById("portionUnit");
  const templateSuggestionEl = document.getElementById("templateSuggestion");
  const btnUseTemplate = document.getElementById("btnUseTemplate");

  function normalizeDescription(desc) {
    return desc
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ")
      .trim();
  }

  function getFullDescription() {
    const desc = mealDescriptionEl.value.trim();
    const amount = portionAmountEl.value.trim();
    const unit = portionUnitEl.value;

    if (!desc) return "";

    // Construimos algo tipo "1 taza de caf√© con leche"
    if (!amount && unit === "ninguna") {
      return desc;
    }

    const cantidadTexto = amount || "1";

    if (unit === "ninguna") {
      return `${cantidadTexto} ${desc}`;
    }

    return `${cantidadTexto} ${unit} de ${desc}`;
  }

  function loadTemplates() {
    try {
      const raw = localStorage.getItem(TEMPLATES_KEY);
      return raw ? JSON.parse(raw) : {};
    } catch (e) {
      console.warn("Error leyendo templates:", e);
      return {};
    }
  }

  function saveTemplates(obj) {
    try {
      localStorage.setItem(TEMPLATES_KEY, JSON.stringify(obj));
    } catch (e) {
      console.warn("Error guardando templates:", e);
    }
  }

  function checkTemplateForCurrentDescription() {
    const fullDesc = getFullDescription();
    const norm = normalizeDescription(fullDesc);
    if (!norm) {
      templateSuggestionEl.textContent = "";
      btnUseTemplate.style.display = "none";
      return;
    }

    const templates = loadTemplates();
    const t = templates[norm];

    if (t) {
      templateSuggestionEl.textContent =
        "Ya tenemos guardados valores para esta comida (con esa cantidad/unidad). Pod√©s usarlos sin consultar a ChatGPT.";
      btnUseTemplate.style.display = "inline-flex";

      btnUseTemplate.onclick = () => {
        document.getElementById("caloriesInput").value =
          t.calorias ?? "";
        document.getElementById("sugarInput").value =
          t.azucares_g ?? "";
        document.getElementById("fatInput").value =
          t.grasas_g ?? "";
        document.getElementById("proteinInput").value =
          t.proteinas_g ?? "";
      };
    } else {
      templateSuggestionEl.textContent =
        "Todav√≠a no hay datos guardados para esta combinaci√≥n de comida y cantidad.";
      btnUseTemplate.style.display = "none";
    }
  }

  function buildPrompt() {
    const tipo = document.getElementById("mealType").value;
    const fullDesc = getFullDescription();

    if (!fullDesc) {
      alert("Complet√° la comida antes de seguir (cantidad/unidad y descripci√≥n).");
      return null;
    }

    const prompt = `
Eres un nutricionista experto.

Analiza la siguiente comida y devuelve solo un JSON:

Tipo de comida: ${tipo}
Descripci√≥n detallada de la comida: "${fullDesc}"

Quiero que estimes de forma realista:
- calor√≠as totales (kcal)
- gramos de az√∫cares
- gramos de grasas
- gramos de prote√≠nas

IMPORTANTE:
Responde SOLO un JSON v√°lido, sin texto extra, sin comentarios, sin explicaci√≥n.
Usa exactamente este formato de claves:
{
  "calorias": 0,
  "azucares_g": 0,
  "grasas_g": 0,
  "proteinas_g": 0
}
Completa los valores con n√∫meros (pueden ser decimales).
`;
    return prompt.trim();
  }

  function openChatGPT() {
    const prompt = buildPrompt();
    if (!prompt) return;

    const url = "https://chat.openai.com/?q=" + encodeURIComponent(prompt);
    window.open(url, "_blank");
  }

  function importFromJson() {
    const raw = document.getElementById("jsonChatGPT").value.trim();
    if (!raw) {
      alert("Peg√° el JSON que te devolvi√≥ ChatGPT.");
      return;
    }

    try {
      const data = JSON.parse(raw);

      document.getElementById("caloriesInput").value =
        data.calorias ?? "";
      document.getElementById("sugarInput").value =
        data.azucares_g ?? "";
      document.getElementById("fatInput").value =
        data.grasas_g ?? "";
      document.getElementById("proteinInput").value =
        data.proteinas_g ?? "";

      alert("Valores importados.");
    } catch (e) {
      alert("El texto pegado no es un JSON v√°lido. Revis√° el formato.");
    }
  }

  function loadMeals() {
    let all = [];
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) all = JSON.parse(raw);
    } catch (e) {
      console.warn("Error leyendo meals:", e);
    }

    const today = new Date();
    const todayStr = today.toISOString().slice(0, 10);

    const todaysMeals = all.filter(m => m.date.startsWith(todayStr));

    const sumCal = todaysMeals.reduce((acc, m) => acc + (m.calorias || 0), 0);
    const sumSugar = todaysMeals.reduce((acc, m) => acc + (m.azucares_g || 0), 0);
    const sumFat = todaysMeals.reduce((acc, m) => acc + (m.grasas_g || 0), 0);
    const sumProtein = todaysMeals.reduce((acc, m) => acc + (m.proteinas_g || 0), 0);

    document.getElementById("sumCal").textContent = sumCal.toFixed(1);
    document.getElementById("sumSugar").textContent = sumSugar.toFixed(1);
    document.getElementById("sumFat").textContent = sumFat.toFixed(1);
    document.getElementById("sumProtein").textContent = sumProtein.toFixed(1);

    const list = document.getElementById("mealsList");
    list.innerHTML = "";

    if (todaysMeals.length === 0) {
      list.innerHTML = '<span class="small-helper">Todav√≠a no hay registros hoy.</span>';
      return;
    }

    todaysMeals.forEach(m => {
      const div = document.createElement("div");
      div.className = "meal-item";
      div.innerHTML = `
        <strong>${m.tipo}</strong> ¬∑ ${new Date(m.date).toLocaleTimeString()}
        <br/>
        <span>${m.descripcion}</span>
        <br/>
        <span class="small-helper">
          ${m.calorias?.toFixed?.(1) || m.calorias || 0} kcal ¬∑
          ${m.proteinas_g?.toFixed?.(1) || m.proteinas_g || 0} g prot ¬∑
          ${m.grasas_g?.toFixed?.(1) || m.grasas_g || 0} g grasa ¬∑
          ${m.azucares_g?.toFixed?.(1) || m.azucares_g || 0} g az√∫car
        </span>
      `;
      list.appendChild(div);
    });
  }

  function saveTemplateFromMeal(fullDesc, cal, azu, gra, pro) {
    const norm = normalizeDescription(fullDesc);
    if (!norm) return;

    const templates = loadTemplates();
    const existing = templates[norm];

    if (!existing) {
      templates[norm] = {
        calorias: cal,
        azucares_g: azu,
        grasas_g: gra,
        proteinas_g: pro,
        count: 1
      };
    } else {
      const n = (existing.count || 1) + 1;
      existing.calorias = ((existing.calorias || 0) * (n - 1) + cal) / n;
      existing.azucares_g = ((existing.azucares_g || 0) * (n - 1) + azu) / n;
      existing.grasas_g = ((existing.grasas_g || 0) * (n - 1) + gra) / n;
      existing.proteinas_g = ((existing.proteinas_g || 0) * (n - 1) + pro) / n;
      existing.count = n;
      templates[norm] = existing;
    }

    saveTemplates(templates);
    checkTemplateForCurrentDescription();
  }

  function saveMeal() {
    const tipo = document.getElementById("mealType").value;
    const fullDesc = getFullDescription();
    const cal = Number(document.getElementById("caloriesInput").value || 0);
    const azu = Number(document.getElementById("sugarInput").value || 0);
    const gra = Number(document.getElementById("fatInput").value || 0);
    const pro = Number(document.getElementById("proteinInput").value || 0);
    const status = document.getElementById("saveStatus");

    if (!fullDesc) {
      status.textContent = "Complet√° la comida (cantidad/unidad y descripci√≥n).";
      status.style.color = "var(--danger)";
      return;
    }

    if (!cal && !azu && !gra && !pro) {
      status.textContent = "Import√° o carg√° al menos un dato nutricional antes de guardar.";
      status.style.color = "var(--danger)";
      return;
    }

    let all = [];
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) all = JSON.parse(raw);
    } catch (e) {
      console.warn("No se pudo leer el storage:", e);
    }

    const meal = {
      tipo,
      descripcion: fullDesc,
      calorias: cal,
      azucares_g: azu,
      grasas_g: gra,
      proteinas_g: pro,
      date: new Date().toISOString()
    };

    all.push(meal);

    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(all));
      status.textContent = "Comida guardada en el registro.";
      status.style.color = "#4ade80";

      // Tambi√©n actualizamos el template (mini base de datos)
      saveTemplateFromMeal(fullDesc, cal, azu, gra, pro);
      loadMeals();
    } catch (e) {
      status.textContent = "No se pudo guardar. Revis√° espacio/permisos.";
      status.style.color = "var(--danger)";
    }
  }

  document
    .getElementById("btnOpenChatGPT")
    .addEventListener("click", openChatGPT);
  document
    .getElementById("btnImportJson")
    .addEventListener("click", importFromJson);
  document
    .getElementById("btnSaveMeal")
    .addEventListener("click", saveMeal);

  mealDescriptionEl.addEventListener("blur", checkTemplateForCurrentDescription);
  portionAmountEl.addEventListener("blur", checkTemplateForCurrentDescription);
  portionUnitEl.addEventListener("change", checkTemplateForCurrentDescription);

  mealDescriptionEl.addEventListener("input", () => {
    templateSuggestionEl.textContent = "";
    btnUseTemplate.style.display = "none";
  });
  portionAmountEl.addEventListener("input", () => {
    templateSuggestionEl.textContent = "";
    btnUseTemplate.style.display = "none";
  });
  portionUnitEl.addEventListener("change", () => {
    templateSuggestionEl.textContent = "";
    btnUseTemplate.style.display = "none";
  });

  // Cargar resumen al abrir
  loadMeals();
  checkTemplateForCurrentDescription();
</script>
</body>
</html>