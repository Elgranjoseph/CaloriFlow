<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CaloriFlow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #151b3c 0, #050712 55%, #020308 100%);
      color: #fff;
    }
    .app-shell {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 24px 12px 40px;
    }
    .card {
      width: 100%;
      max-width: 480px;
      background: rgba(5, 9, 30, 0.96);
      border-radius: 24px;
      padding: 20px 18px 28px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.04);
    }
    h1 {
      text-align: center;
      margin: 4px 0 2px;
      letter-spacing: 0.06em;
      font-size: 30px;
    }
    .subtitle {
      text-align: center;
      font-size: 13px;
      color: #c0c7ff;
      margin-bottom: 20px;
    }
    .section-title {
      font-size: 14px;
      margin: 14px 0 6px;
      color: #d7ddff;
    }
    label {
      font-size: 13px;
      color: #d7ddff;
      display: block;
      margin-bottom: 4px;
    }
    select,
    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 10px 12px;
      background: rgba(9, 13, 40, 0.95);
      color: #fff;
      font-size: 15px;
      outline: none;
    }
    textarea {
      resize: vertical;
      min-height: 72px;
    }
    select:focus,
    input:focus,
    textarea:focus {
      border-color: #7c8dff;
      box-shadow: 0 0 0 1px rgba(124, 141, 255, 0.4);
    }
    .row {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }
    .row > div {
      flex: 1;
    }
    .btn {
      width: 100%;
      padding: 12px;
      border-radius: 999px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.1s;
    }
    .btn:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: none;
      opacity: 0.92;
    }
    .btn-primary {
      background: linear-gradient(135deg, #7b5cff, #c961ff);
      color: white;
      box-shadow: 0 10px 24px rgba(123, 92, 255, 0.6);
    }
    .btn-green {
      background: linear-gradient(135deg, #21c36b, #2de38b);
      color: #032313;
      box-shadow: 0 10px 24px rgba(21, 186, 100, 0.55);
    }
    .btn-yellow {
      background: linear-gradient(135deg, #ffd54f, #ffb300);
      color: #3b2a00;
      box-shadow: 0 10px 24px rgba(255, 191, 0, 0.55);
    }
    .btn-blue {
      background: linear-gradient(135deg, #42a5f5, #1e88e5);
      color: #02121f;
      box-shadow: 0 10px 24px rgba(33, 150, 243, 0.55);
    }
    .btn-back {
      background: linear-gradient(135deg, #ffb74d, #ff9800);
      color: #2b1400;
      padding: 9px 16px;
      border-radius: 999px;
      font-size: 14px;
      margin-bottom: 10px;
      width: auto;
      box-shadow: 0 8px 18px rgba(255, 152, 0, 0.5);
    }
    .btn-small {
      padding: 8px 12px;
      font-size: 13px;
      border-radius: 999px;
      width: auto;
    }
    .btn-outline {
      background: transparent;
      border: 1px dashed rgba(255, 255, 255, 0.35);
      color: #e0e4ff;
      box-shadow: none;
    }
    .hint {
      font-size: 12px;
      color: #a8b0ff;
      margin-top: 4px;
    }
    .footer-note {
      font-size: 11px;
      color: #a0a7d7;
      margin-top: 14px;
      text-align: center;
      opacity: 0.86;
    }
    .hidden {
      display: none;
    }

    /* Lista de √≠tems de la comida */
    .items-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
      margin-bottom: 4px;
    }
    .items-header span {
      font-size: 13px;
      color: #d7ddff;
    }
    .items-list {
      margin-top: 4px;
      max-height: 150px;
      overflow-y: auto;
    }
    .meal-item-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(15, 20, 60, 0.95);
      border-radius: 14px;
      padding: 6px 10px;
      margin-top: 6px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      font-size: 13px;
    }
    .meal-item-card span {
      flex: 1;
      padding-right: 8px;
    }
    .meal-item-card button {
      border: none;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      background: rgba(244, 67, 54, 0.16);
      color: #ffcdd2;
    }

    /* Resumen */
    .summary-block {
      background: rgba(10, 15, 45, 0.95);
      border-radius: 20px;
      padding: 14px 14px 18px;
      margin-top: 12px;
      border: 1px solid rgba(255, 255, 255, 0.06);
    }
    .summary-title {
      font-size: 22px;
      margin-bottom: 6px;
    }
    .summary-row {
      font-size: 14px;
      margin: 2px 0;
    }
    .summary-row strong {
      display: inline-block;
      width: 140px;
    }
    .meal-entry {
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      padding-top: 8px;
      margin-top: 8px;
      font-size: 13px;
    }
    .meal-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }
    .pill {
      display: inline-block;
      padding: 2px 9px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(123, 92, 255, 0.24);
      color: #e0e5ff;
    }
    .delete-small {
      border: none;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 11px;
      background: rgba(244, 67, 54, 0.15);
      color: #ffcdd2;
      cursor: pointer;
    }

    /* Base aprendida */
    .base-entry {
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      padding-top: 8px;
      margin-top: 8px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }
    .base-entry-info {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="card" id="section-registro">
      <h1>CaloriFlow</h1>
      <div class="subtitle">Registro diario con memoria propia.</div>

      <div class="section-title">Tipo de comida</div>
      <select id="tipoComida">
        <option>Desayuno</option>
        <option>Almuerzo</option>
        <option>Merienda</option>
        <option>Cena</option>
        <option>Snack</option>
      </select>

      <div class="section-title">¬øQu√© comiste?</div>
      <textarea id="descripcion" placeholder="Ej: 1 taza de caf√© con leche"></textarea>

      <!-- Fila cantidad / porci√≥n / alimento -->
      <div class="row">
        <div>
          <label for="cantidad">Cant.</label>
          <input type="number" id="cantidad" min="1" value="1" />
        </div>
        <div>
          <label for="porcion">Porci√≥n</label>
          <select id="porcion">
            <option value="taza">taza</option>
            <option value="vaso">vaso</option>
            <option value="unidad">unidad</option>
            <option value="porci√≥n">porci√≥n</option>
            <option value="rebanada">rebanada</option>
            <option value="cucharada">cucharada</option>
            <option value="cucharadita">cucharadita</option>
          </select>
        </div>
        <div>
          <label for="alimento">Alimento</label>
          <input
            type="text"
            id="alimento"
            placeholder="Caf√©, tostada, fruta..."
          />
        </div>
      </div>

      <!-- Cabecera y bot√≥n para √≠tems -->
      <div class="items-header">
        <span>√çtems en esta comida</span>
        <button class="btn btn-small btn-outline" id="btnAgregarItem">
          ‚ûï A√±adir √≠tem
        </button>
      </div>
      <div class="items-list" id="listaItems"></div>

      <button class="btn btn-primary" id="btnPrompt">
        üß† Generar prompt para ChatGPT
      </button>

      <div class="section-title" style="margin-top: 14px;">
        Pega aqu√≠ el resultado de ChatGPT (JSON)
      </div>
      <textarea
        id="jsonInput"
        placeholder='Pega aqu√≠ el resultado de ChatGPT (JSON)'
      ></textarea>

      <button class="btn btn-green" id="btnAgregarComida">
        ‚úÖ Agregar comida
      </button>

      <button class="btn btn-yellow" id="btnVerResumen">
        üìä Ver resumen de hoy
      </button>

      <button class="btn btn-blue" id="btnVerBase">
        üìö Ver base aprendida
      </button>

      <div class="footer-note">
        Todo se guarda solo en este dispositivo usando memoria local.
      </div>
    </div>

    <!-- Secci√≥n Resumen -->
    <div class="card hidden" id="section-resumen">
      <button class="btn-back" id="btnVolverRegistroDesdeResumen">
        ‚Üê Volver al registro
      </button>
      <h2 class="summary-title">Resumen de hoy</h2>
      <p style="font-size: 13px; color: #c3c8ff; margin-top: 0;">
        Suma de todas las comidas registradas hoy.
      </p>

      <div class="summary-block">
        <div class="summary-row">
          <strong>Calor√≠as totales:</strong>
          <span id="totalCalorias">0</span>
        </div>
        <div class="summary-row">
          <strong>Az√∫cares totales (g):</strong>
          <span id="totalAzucares">0</span>
        </div>
        <div class="summary-row">
          <strong>Grasas totales (g):</strong>
          <span id="totalGrasas">0</span>
        </div>
        <div class="summary-row">
          <strong>Prote√≠nas totales (g):</strong>
          <span id="totalProteinas">0</span>
        </div>

        <div style="margin-top: 12px; font-size: 14px; font-weight: 600;">
          Comidas registradas
        </div>
        <div id="listaComidasHoy" style="margin-top: 4px;">
          Todav√≠a no registraste comidas hoy.
        </div>
      </div>
    </div>

    <!-- Secci√≥n Base aprendida -->
    <div class="card hidden" id="section-base">
      <button class="btn-back" id="btnVolverRegistroDesdeBase">
        ‚Üê Volver al registro
      </button>
      <h2 class="summary-title">Base aprendida</h2>
      <p style="font-size: 13px; color: #c3c8ff; margin-top: 0;">
        Comidas que la app ya conoce. Si repet√≠s una descripci√≥n, usar√° estos
        valores sin pedir de nuevo a ChatGPT.
      </p>

      <div class="summary-block">
        <div id="listaBaseAprendida">
          Todav√≠a no hay comidas aprendidas.
        </div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "caloriflow_v3";

    let state = {
      comidas: [],
      baseAprendida: {},
    };

    let currentItems = []; // √≠tems de la comida en construcci√≥n

    function todayISO() {
      const d = new Date();
      return d.toISOString().slice(0, 10);
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed && Array.isArray(parsed.comidas) && parsed.baseAprendida) {
            state = parsed;
          }
        }
      } catch (e) {
        console.error("Error al leer storage", e);
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function showSection(id) {
      document.getElementById("section-registro").classList.add("hidden");
      document.getElementById("section-resumen").classList.add("hidden");
      document.getElementById("section-base").classList.add("hidden");
      document.getElementById(id).classList.remove("hidden");
    }

    function normalizarDescripcion(texto) {
      return texto.trim().toLowerCase();
    }

    // ---------- √çTEMS DE LA COMIDA ----------
    function renderItems() {
      const cont = document.getElementById("listaItems");
      cont.innerHTML = "";
      if (currentItems.length === 0) {
        cont.innerHTML =
          '<div class="hint">Todav√≠a no agregaste √≠tems a esta comida.</div>';
        return;
      }
      currentItems.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "meal-item-card";
        const span = document.createElement("span");
        span.textContent = item.texto;
        const btn = document.createElement("button");
        btn.textContent = "Eliminar";
        btn.onclick = () => {
          currentItems.splice(index, 1);
          actualizarDescripcionDesdeItems();
          renderItems();
        };
        div.appendChild(span);
        div.appendChild(btn);
        cont.appendChild(div);
      });
    }

    function actualizarDescripcionDesdeItems() {
      const descripcionInput = document.getElementById("descripcion");
      if (currentItems.length === 0) return; // no tocar si se vac√≠a, dejo al usuario escribir a mano
      const texto = currentItems.map((i) => i.texto).join(" + ");
      descripcionInput.value = texto;
    }

    function agregarItemActual() {
      const cant = document.getElementById("cantidad").value.trim();
      const porcion = document.getElementById("porcion").value;
      const alimento = document.getElementById("alimento").value.trim();

      if (!alimento) {
        alert("Escrib√≠ el alimento para poder agregar el √≠tem.");
        return;
      }

      const cantidadNum = cant === "" ? 1 : Number(cant);
      const cantidadValida = !isNaN(cantidadNum) && cantidadNum > 0 ? cantidadNum : 1;

      let texto = `${cantidadValida} ${porcion}`;
      if (alimento) {
        texto += ` de ${alimento}`;
      }

      currentItems.push({ cantidad: cantidadValida, porcion, alimento, texto });
      document.getElementById("alimento").value = "";
      actualizarDescripcionDesdeItems();
      renderItems();
    }

    // ---------- RESUMEN ----------
    function renderResumenHoy() {
      const hoy = todayISO();
      const comidasHoy = state.comidas.filter((c) => c.fecha === hoy);

      let tCal = 0,
        tAz = 0,
        tGr = 0,
        tPr = 0;
      comidasHoy.forEach((c) => {
        tCal += c.calorias || 0;
        tAz += c.azucares_g || 0;
        tGr += c.grasas_g || 0;
        tPr += c.proteinas_g || 0;
      });

      document.getElementById("totalCalorias").textContent = tCal.toFixed(1);
      document.getElementById("totalAzucares").textContent = tAz.toFixed(1);
      document.getElementById("totalGrasas").textContent = tGr.toFixed(1);
      document.getElementById("totalProteinas").textContent = tPr.toFixed(1);

      const cont = document.getElementById("listaComidasHoy");
      cont.innerHTML = "";
      if (comidasHoy.length === 0) {
        cont.textContent = "Todav√≠a no registraste comidas hoy.";
        return;
      }

      comidasHoy
        .slice()
        .sort((a, b) => a.timestamp - b.timestamp)
        .forEach((c) => {
          const div = document.createElement("div");
          div.className = "meal-entry";

          const header = document.createElement("div");
          header.className = "meal-entry-header";

          const left = document.createElement("div");
          left.innerHTML = `<span class="pill">${c.tipo}</span> ¬∑ <span style="font-size:11px;opacity:.8">${c.hora}</span>`;

          const btnDel = document.createElement("button");
          btnDel.className = "delete-small";
          btnDel.textContent = "Eliminar";
          btnDel.onclick = () => {
            state.comidas = state.comidas.filter((x) => x.id !== c.id);
            saveState();
            renderResumenHoy();
          };

          header.appendChild(left);
          header.appendChild(btnDel);

          const desc = document.createElement("div");
          desc.textContent = c.descripcion;

          const macros = document.createElement("div");
          macros.style.fontSize = "12px";
          macros.style.marginTop = "2px";
          macros.style.opacity = "0.9";
          macros.textContent = `${c.calorias.toFixed(
            1
          )} kcal ¬∑ ${c.proteinas_g.toFixed(
            1
          )} g prot ¬∑ ${c.grasas_g.toFixed(
            1
          )} g grasa ¬∑ ${c.azucares_g.toFixed(1)} g az√∫car`;

          div.appendChild(header);
          div.appendChild(desc);
          div.appendChild(macros);

          cont.appendChild(div);
        });
    }

    // ---------- BASE APRENDIDA ----------
    function renderBaseAprendida() {
      const cont = document.getElementById("listaBaseAprendida");
      const claves = Object.keys(state.baseAprendida);
      cont.innerHTML = "";
      if (claves.length === 0) {
        cont.textContent = "Todav√≠a no hay comidas aprendidas.";
        return;
      }

      claves
        .slice()
        .sort((a, b) => a.localeCompare(b))
        .forEach((clave) => {
          const datos = state.baseAprendida[clave];
          const div = document.createElement("div");
          div.className = "base-entry";

          const info = document.createElement("div");
          info.className = "base-entry-info";
          info.innerHTML = `<strong>${clave}</strong><br>${datos.calorias.toFixed(
            1
          )} kcal ¬∑ ${datos.proteinas_g.toFixed(
            1
          )} g prot ¬∑ ${datos.grasas_g.toFixed(
            1
          )} g grasa ¬∑ ${datos.azucares_g.toFixed(1)} g az√∫car`;

          const btnDel = document.createElement("button");
          btnDel.className = "delete-small";
          btnDel.textContent = "Eliminar";
          btnDel.onclick = () => {
            if (confirm("¬øSeguro que quer√©s borrar esta comida aprendida?")) {
              delete state.baseAprendida[clave];
              saveState();
              renderBaseAprendida();
            }
          };

          div.appendChild(info);
          div.appendChild(btnDel);
          cont.appendChild(div);
        });
    }

    // ---------- EVENTOS PRINCIPALES ----------
    document.addEventListener("DOMContentLoaded", () => {
      loadState();
      renderItems();

      document
        .getElementById("btnAgregarItem")
        .addEventListener("click", agregarItemActual);

      document.getElementById("btnPrompt").addEventListener("click", () => {
        const tipo = document.getElementById("tipoComida").value;
        const desc = document.getElementById("descripcion").value.trim();
        if (!desc) {
          alert("Escrib√≠ qu√© comiste (o agreg√° √≠tems) antes de generar el prompt.");
          return;
        }

        const prompt = `
Estoy construyendo una app personal de registro nutricional.

Dame una estimaci√≥n aproximada para la siguiente comida:

Tipo de comida: ${tipo}
Descripci√≥n detallada: ${desc}

Responde SOLO un JSON v√°lido, en una sola l√≠nea, sin ning√∫n texto extra, sin comentarios, sin explicaciones.
Usa exactamente estas claves num√©ricas (pueden ser decimales):

{"calorias": 0, "azucares_g": 0, "grasas_g": 0, "proteinas_g": 0}
`.trim();

        navigator.clipboard
          .writeText(prompt)
          .then(() => {
            alert(
              "Prompt copiado al portapapeles. Abr√≠ tu ChatGPT y pegalo en la conversaci√≥n que quieras."
            );
          })
          .catch(() => {
            alert(
              "No se pudo copiar autom√°ticamente. Si quer√©s, copi√° el texto manualmente."
            );
          });
      });

      document
        .getElementById("btnAgregarComida")
        .addEventListener("click", () => {
          const tipo = document.getElementById("tipoComida").value;
          const descripcion = document
            .getElementById("descripcion")
            .value.trim();
          const jsonText = document.getElementById("jsonInput").value.trim();

          if (!descripcion) {
            alert("Escrib√≠ qu√© comiste antes de guardar la comida.");
            return;
          }

          const clave = normalizarDescripcion(descripcion);
          let datos;

          if (jsonText) {
            try {
              const obj = JSON.parse(jsonText);
              const c = Number(obj.calorias);
              const a = Number(obj.azucares_g);
              const g = Number(obj.grasas_g);
              const p = Number(obj.proteinas_g);
              if (
                [c, a, g, p].some(
                  (v) => typeof v !== "number" || !isFinite(v)
                )
              ) {
                throw new Error("Valores inv√°lidos");
              }
              datos = {
                calorias: c,
                azucares_g: a,
                grasas_g: g,
                proteinas_g: p,
              };
              // Aprender / actualizar base
              state.baseAprendida[clave] = datos;
            } catch (e) {
              alert(
                "El JSON no es v√°lido. Verific√° que tenga solo las claves calorias, azucares_g, grasas_g, proteinas_g."
              );
              return;
            }
          } else {
            // Sin JSON: intentar usar lo aprendido
            if (state.baseAprendida[clave]) {
              datos = state.baseAprendida[clave];
            } else {
              alert(
                "Para esta descripci√≥n todav√≠a no tengo datos. Us√° ChatGPT una vez y peg√° el JSON."
              );
              return;
            }
          }

          const ahora = new Date();
          const comida = {
            id: Date.now() + Math.random(),
            tipo,
            descripcion,
            fecha: todayISO(),
            hora: ahora.toLocaleTimeString(),
            timestamp: ahora.getTime(),
            ...datos,
          };

          state.comidas.push(comida);
          saveState();

          // limpiar campos para la pr√≥xima comida
          document.getElementById("jsonInput").value = "";
          document.getElementById("descripcion").value = "";
          currentItems = [];
          renderItems();

          alert("Comida guardada.");
        });

      document
        .getElementById("btnVerResumen")
        .addEventListener("click", () => {
          renderResumenHoy();
          showSection("section-resumen");
        });

      document.getElementById("btnVerBase").addEventListener("click", () => {
        renderBaseAprendida();
        showSection("section-base");
      });

      document
        .getElementById("btnVolverRegistroDesdeResumen")
        .addEventListener("click", () => showSection("section-registro"));

      document
        .getElementById("btnVolverRegistroDesdeBase")
        .addEventListener("click", () => showSection("section-registro"));
    });
  </script>
</body>
</html>