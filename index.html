<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CaloriFlow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-main: #020617;
      --card-bg: radial-gradient(circle at top, #1e293b, #020617);
      --accent: #818cf8;
      --accent-strong: #6366f1;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #ef4444;
      --green-btn: #22c55e;
      --yellow-btn: #facc15;
      --blue-btn: #0ea5e9;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
    }

    .card {
      background: var(--card-bg);
      border-radius: 24px;
      padding: 20px 18px 24px;
      box-shadow: 0 25px 60px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    h1 {
      text-align: center;
      font-size: 2.2rem;
      letter-spacing: 0.04em;
      margin-bottom: 4px;
      color: #f9fafb;
    }

    .subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: var(--text-soft);
      margin-bottom: 18px;
    }

    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 6px;
      color: var(--text-soft);
    }

    select,
    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      padding: 11px 12px;
      font-size: 0.95rem;
      outline: none;
    }

    select:focus,
    input:focus,
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.8);
    }

    textarea {
      min-height: 64px;
      resize: vertical;
    }

    .field-group {
      margin-bottom: 14px;
    }

    .row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .row .col {
      flex: 1;
    }

    .btn {
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 14px 18px;
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 10px;
      cursor: pointer;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out,
        filter 0.08s ease-out;
      color: #020617;
    }

    .btn span.icon {
      font-size: 1.15rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #6366f1, #a855f7);
      color: #f9fafb;
      box-shadow: 0 12px 25px rgba(88, 28, 135, 0.65);
    }

    .btn-primary:active {
      transform: scale(0.97);
      box-shadow: 0 6px 16px rgba(88, 28, 135, 0.8);
      filter: brightness(0.96);
    }

    .btn-green {
      background: var(--green-btn);
      box-shadow: 0 10px 22px rgba(34, 197, 94, 0.45);
    }

    .btn-yellow {
      background: var(--yellow-btn);
      box-shadow: 0 10px 22px rgba(250, 204, 21, 0.45);
    }

    .btn-blue {
      background: var(--blue-btn);
      box-shadow: 0 10px 22px rgba(14, 165, 233, 0.45);
    }

    .btn-green:active,
    .btn-yellow:active,
    .btn-blue:active {
      transform: scale(0.97);
      filter: brightness(0.96);
    }

    .btn-back {
      background: var(--yellow-btn);       /* COLOR VISIBLE OTRA VEZ */
      border-radius: 999px;
      border: none;
      color: #111827;
      padding: 8px 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 14px;
      cursor: pointer;
      font-size: 0.9rem;
      box-shadow: 0 8px 18px rgba(250, 204, 21, 0.45);
    }

    .btn-back span.icon {
      font-size: 1rem;
    }

    .hint {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .hidden {
      display: none;
    }

    /* Resumen */
    .summary-title {
      font-size: 1.4rem;
      margin-bottom: 6px;
    }

    .summary-sub {
      font-size: 0.95rem;
      color: var(--text-soft);
      margin-bottom: 12px;
    }

    .summary-box {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 18px;
      padding: 14px 14px 10px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      margin-bottom: 14px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .summary-row strong {
      color: #e5e7eb;
    }

    .summary-list-title {
      margin-top: 6px;
      margin-bottom: 6px;
      font-weight: 600;
    }

    .meal-item {
      border-radius: 14px;
      padding: 10px 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(51, 65, 85, 0.8);
      margin-bottom: 8px;
    }

    .meal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }

    .meal-type {
      font-weight: 600;
    }

    .meal-time {
      color: var(--text-soft);
      font-size: 0.8rem;
    }

    .meal-desc {
      font-size: 0.9rem;
      margin-bottom: 4px;
    }

    .meal-macros {
      font-size: 0.82rem;
      color: var(--text-soft);
    }

    .btn-delete {
      background: rgba(248, 113, 113, 0.16);
      border-radius: 999px;
      border: 1px solid rgba(248, 113, 113, 0.6);
      color: #fecaca;
      padding: 4px 10px;
      font-size: 0.78rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-delete span.icon {
      font-size: 0.9rem;
    }

    .empty-text {
      font-size: 0.9rem;
      color: var(--text-soft);
      text-align: center;
      margin-top: 6px;
    }

    /* tabla base aprendida */
    .learn-item {
      border-radius: 14px;
      padding: 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(51, 65, 85, 0.85);
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .learn-name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .learn-macros {
      font-size: 0.82rem;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    @media (max-width: 400px) {
      .card {
        padding: 16px 14px 20px;
      }

      h1 {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- PANTALLA PRINCIPAL -->
    <div id="pantalla-registro" class="card">
      <h1>CaloriFlow</h1>
      <p class="subtitle">Registro diario con memoria propia.</p>

      <div class="field-group">
        <label for="tipoComida">Tipo de comida</label>
        <select id="tipoComida">
          <option>Desayuno</option>
          <option>Almuerzo</option>
          <option>Merienda</option>
          <option>Cena</option>
          <option>Snack</option>
        </select>
      </div>

      <div class="field-group">
        <label for="descripcion">
          ¬øQu√© comiste?
        </label>
        <textarea
          id="descripcion"
          placeholder="Ej: 1 taza de caf√© con leche"
        ></textarea>
      </div>

      <!-- Atajo cantidad / porci√≥n / alimento -->
      <div class="row">
        <div class="col">
          <label for="cant">Cant.</label>
          <input
            type="number"
            id="cant"
            min="1"
            step="1"
            inputmode="numeric"
            value="1"
          />
        </div>
        <div class="col">
          <label for="porcion">Porci√≥n</label>
          <select id="porcion">
            <option value="">(sin)</option>
            <option value="taza">taza</option>
            <option value="vaso">vaso</option>
            <option value="rebanada">rebanada</option>
            <option value="unidad">unidad</option>
            <option value="porci√≥n">porci√≥n</option>
            <option value="plato">plato</option>
          </select>
        </div>
        <div class="col">
          <label for="alimento">Alimento</label>
          <input
            type="text"
            id="alimento"
            placeholder="caf√© con leche, tostada..."
          />
        </div>
      </div>

      <button id="btnPrompt" class="btn btn-primary">
        <span class="icon">üß†</span>
        <span>Generar prompt para ChatGPT</span>
      </button>

      <div class="field-group" style="margin-top: 14px;">
        <label for="jsonChat">Pega aqu√≠ el resultado de ChatGPT (JSON)</label>
        <textarea id="jsonChat"></textarea>
      </div>

      <button id="btnAgregar" class="btn btn-green">
        <span class="icon">‚úÖ</span>
        <span>Agregar comida</span>
      </button>

      <button id="btnResumen" class="btn btn-yellow">
        <span class="icon">üìä</span>
        <span>Ver resumen de hoy</span>
      </button>

      <button id="btnBaseAprendida" class="btn btn-blue">
        <span class="icon">üìö</span>
        <span>Ver base aprendida</span>
      </button>

      <p class="hint" style="margin-top: 10px;">
        Todo se guarda solo en este dispositivo usando memoria local.
      </p>
    </div>

    <!-- PANTALLA RESUMEN -->
    <div id="pantalla-resumen" class="card hidden">
      <button id="btnVolverRegistro1" class="btn-back">
        <span class="icon">‚Üê</span>
        <span>Volver al registro</span>
      </button>

      <h2 class="summary-title">Resumen de hoy</h2>
      <p class="summary-sub">
        Suma de todas las comidas registradas hoy.
      </p>

      <div class="summary-box" id="boxTotales">
        <div class="summary-row">
          <span>Calor√≠as totales:</span>
          <strong id="totCalorias">0</strong>
        </div>
        <div class="summary-row">
          <span>Az√∫cares totales (g):</span>
          <strong id="totAzucares">0</strong>
        </div>
        <div class="summary-row">
          <span>Grasas totales (g):</span>
          <strong id="totGrasas">0</strong>
        </div>
        <div class="summary-row">
          <span>Prote√≠nas totales (g):</span>
          <strong id="totProteinas">0</strong>
        </div>
      </div>

      <p class="summary-list-title">Comidas registradas</p>
      <div id="listaComidas"></div>
      <p id="textoSinComidas" class="empty-text hidden">
        Todav√≠a no registraste comidas hoy.
      </p>
    </div>

    <!-- PANTALLA BASE APRENDIDA -->
    <div id="pantalla-base" class="card hidden">
      <button id="btnVolverRegistro2" class="btn-back">
        <span class="icon">‚Üê</span>
        <span>Volver al registro</span>
      </button>

      <h2 class="summary-title">Base aprendida</h2>
      <p class="summary-sub">
        Comidas que la app ya conoce. Si volv√©s a usar la misma descripci√≥n,
        se toman estos valores sin preguntarle a ChatGPT.
      </p>

      <div id="listaAprendida"></div>
      <p id="textoSinAprendida" class="empty-text hidden">
        Todav√≠a no hay comidas aprendidas.
      </p>
    </div>
  </div>

  <script>
    // --- utilidades de storage ---
    const STORAGE_COMIDAS = "caloriflow_comidas_v1";
    const STORAGE_BASE = "caloriflow_base_v1";

    function cargarJSON(key, defaultValue) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return defaultValue;
        return JSON.parse(raw);
      } catch (e) {
        console.error("Error leyendo localStorage", key, e);
        return defaultValue;
      }
    }

    function guardarJSON(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch (e) {
        console.error("Error guardando localStorage", key, e);
      }
    }

    // --- elementos DOM ---
    const pantallaRegistro = document.getElementById("pantalla-registro");
    const pantallaResumen = document.getElementById("pantalla-resumen");
    const pantallaBase = document.getElementById("pantalla-base");

    const tipoComidaEl = document.getElementById("tipoComida");
    const descripcionEl = document.getElementById("descripcion");
    const cantEl = document.getElementById("cant");
    const porcionEl = document.getElementById("porcion");
    const alimentoEl = document.getElementById("alimento");
    const jsonChatEl = document.getElementById("jsonChat");

    const btnPrompt = document.getElementById("btnPrompt");
       const btnAgregar = document.getElementById("btnAgregar");
    const btnResumen = document.getElementById("btnResumen");
    const btnBaseAprendida = document.getElementById("btnBaseAprendida");

    const btnVolverRegistro1 = document.getElementById("btnVolverRegistro1");
    const btnVolverRegistro2 = document.getElementById("btnVolverRegistro2");

    const totCaloriasEl = document.getElementById("totCalorias");
    const totAzucaresEl = document.getElementById("totAzucares");
    const totGrasasEl = document.getElementById("totGrasas");
    const totProteinasEl = document.getElementById("totProteinas");
    const listaComidasEl = document.getElementById("listaComidas");
    const textoSinComidasEl = document.getElementById("textoSinComidas");

    const listaAprendidaEl = document.getElementById("listaAprendida");
    const textoSinAprendidaEl = document.getElementById("textoSinAprendida");

    // --- datos en memoria ---
    let comidas = cargarJSON(STORAGE_COMIDAS, []);
    let baseAprendida = cargarJSON(STORAGE_BASE, []);

    // --- helpers ---
    function normalizarDescripcion(txt) {
      return txt.trim().toLowerCase().replace(/\s+/g, " ");
    }

    function buscarEnBase(descripcion) {
      const clave = normalizarDescripcion(descripcion);
      return baseAprendida.find((c) => c.clave === clave);
    }

    function agregarABase(descripcion, macros) {
      const clave = normalizarDescripcion(descripcion);
      const existenteIndex = baseAprendida.findIndex((c) => c.clave === clave);
      const nuevo = {
        clave,
        descripcion: descripcion.trim(),
        calorias: macros.calorias,
        azucares_g: macros.azucares_g,
        grasas_g: macros.grasas_g,
        proteinas_g: macros.proteinas_g,
      };
      if (existenteIndex >= 0) {
        baseAprendida[existenteIndex] = nuevo;
      } else {
        baseAprendida.push(nuevo);
      }
      guardarJSON(STORAGE_BASE, baseAprendida);
    }

    function cambiarPantalla(id) {
      pantallaRegistro.classList.add("hidden");
      pantallaResumen.classList.add("hidden");
      pantallaBase.classList.add("hidden");
      document.getElementById(id).classList.remove("hidden");
    }

    // --- atajo Cant / Porci√≥n / Alimento ---
    function actualizarDescripcionDesdeAtajo() {
      const cant = cantEl.value.trim();
      const porc = porcionEl.value.trim();
      const ali = alimentoEl.value.trim();
      // SOLO completar si el campo est√° vac√≠o ‚Üí as√≠ pod√©s escribir varias cosas a mano
      if (cant && porc && ali && descripcionEl.value.trim() === "") {
        descripcionEl.value = `${cant} ${porc} de ${ali}`;
      }
    }

    cantEl.addEventListener("input", actualizarDescripcionDesdeAtajo);
    porcionEl.addEventListener("change", actualizarDescripcionDesdeAtajo);
    alimentoEl.addEventListener("input", actualizarDescripcionDesdeAtajo);

    // --- generar prompt para ChatGPT ---
    btnPrompt.addEventListener("click", async () => {
      const tipo = tipoComidaEl.value;
      const desc = descripcionEl.value.trim();

      if (!desc) {
        alert("Escrib√≠ qu√© comiste antes de generar el prompt.");
        return;
      }

      const prompt = `
Act√∫a como nutricionista. Estoy registrando lo que como.

Tipo de comida: ${tipo}
Descripci√≥n de la comida:
"${desc}"

Calcula los VALORES TOTALES para esa comida.
Responde SOLO un JSON V√ÅLIDO, en UNA sola l√≠nea, sin explicaci√≥n extra, usando EXACTAMENTE este formato de claves:
{"calorias":0,"azucares_g":0,"grasas_g":0,"proteinas_g":0}
      `.trim();

      try {
        await navigator.clipboard.writeText(prompt);
      } catch (e) {
        console.error("No se pudo copiar al portapapeles", e);
      }

      try {
        window.open("https://chat.openai.com", "_blank");
      } catch (e) {
        console.error("No se pudo abrir ChatGPT autom√°ticamente", e);
      }
    });

    // --- agregar comida ---
    btnAgregar.addEventListener("click", () => {
      const tipo = tipoComidaEl.value;
      const descripcion = descripcionEl.value.trim();
      const jsonStr = jsonChatEl.value.trim();

      if (!descripcion) {
        alert("Escrib√≠ una descripci√≥n de la comida.");
        return;
      }

      let macros = null;

      const encontrada = buscarEnBase(descripcion);
      if (encontrada && !jsonStr) {
        macros = {
          calorias: encontrada.calorias,
          azucares_g: encontrada.azucares_g,
          grasas_g: encontrada.grasas_g,
          proteinas_g: encontrada.proteinas_g,
        };
      } else {
        if (!jsonStr) {
          alert(
            "Peg√° el JSON que te devolvi√≥ ChatGPT, o us√° una descripci√≥n que ya hayas guardado antes."
          );
          return;
        }
        try {
          const parsed = JSON.parse(jsonStr);
          const reqKeys = [
            "calorias",
            "azucares_g",
            "grasas_g",
            "proteinas_g",
          ];
          for (const k of reqKeys) {
            if (typeof parsed[k] !== "number") {
              throw new Error("Campo faltante: " + k);
            }
          }
          macros = {
            calorias: parsed.calorias,
            azucares_g: parsed.azucares_g,
            grasas_g: parsed.grasas_g,
            proteinas_g: parsed.proteinas_g,
          };
        } catch (e) {
          console.error(e);
          alert(
            "El JSON pegado no es v√°lido. Asegurate de que ChatGPT responda SOLO algo como: {\"calorias\":120,\"azucares_g\":10,\"grasas_g\":4,\"proteinas_g\":6}"
          );
          return;
        }

        agregarABase(descripcion, macros);
      }

      const ahora = new Date();
      const hora = ahora.toLocaleTimeString("es-UY", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });

      const registro = {
        id: Date.now(),
        fecha: ahora.toISOString().slice(0, 10),
        tipo,
        descripcion,
        hora,
        calorias: macros.calorias,
        azucares_g: macros.azucares_g,
        grasas_g: macros.grasas_g,
        proteinas_g: macros.proteinas_g,
      };

      comidas.push(registro);
      guardarJSON(STORAGE_COMIDAS, comidas);

      jsonChatEl.value = "";
      alert("Comida guardada.");
    });

    // --- resumen de hoy ---
    btnResumen.addEventListener("click", () => {
      actualizarResumen();
      cambiarPantalla("pantalla-resumen");
    });

    function actualizarResumen() {
      const hoy = new Date().toISOString().slice(0, 10);
      const deHoy = comidas.filter((c) => c.fecha === hoy);

      if (deHoy.length === 0) {
        totCaloriasEl.textContent = "0";
        totAzucaresEl.textContent = "0";
        totGrasasEl.textContent = "0";
        totProteinasEl.textContent = "0";
        listaComidasEl.innerHTML = "";
        textoSinComidasEl.classList.remove("hidden");
        return;
      }

      textoSinComidasEl.classList.add("hidden");

      const totales = deHoy.reduce(
        (acc, c) => {
          acc.calorias += c.calorias;
          acc.azucares_g += c.azucares_g;
          acc.grasas_g += c.grasas_g;
          acc.proteinas_g += c.proteinas_g;
          return acc;
        },
        { calorias: 0, azucares_g: 0, grasas_g: 0, proteinas_g: 0 }
      );

      totCaloriasEl.textContent = totales.calorias.toFixed(1);
      totAzucaresEl.textContent = totales.azucares_g.toFixed(1);
      totGrasasEl.textContent = totales.grasas_g.toFixed(1);
      totProteinasEl.textContent = totales.proteinas_g.toFixed(1);

      listaComidasEl.innerHTML = "";
      deHoy
        .slice()
        .reverse()
        .forEach((c) => {
          const div = document.createElement("div");
          div.className = "meal-item";

          const header = document.createElement("div");
          header.className = "meal-header";

          const left = document.createElement("div");
          left.innerHTML = `<span class="meal-type">${c.tipo}</span> ¬∑ <span class="meal-time">${c.hora}</span>`;

          const btnDel = document.createElement("button");
          btnDel.className = "btn-delete";
          btnDel.innerHTML = `<span class="icon">üóëÔ∏è</span><span>Eliminar</span>`;
          btnDel.addEventListener("click", () => {
            if (!confirm("¬øEliminar esta comida del registro de hoy?")) return;
            comidas = comidas.filter((x) => x.id !== c.id);
            guardarJSON(STORAGE_COMIDAS, comidas);
            actualizarResumen();
          });

          header.appendChild(left);
          header.appendChild(btnDel);

          const desc = document.createElement("div");
          desc.className = "meal-desc";
          desc.textContent = "- " + c.descripcion;

          const macros = document.createElement("div");
          macros.className = "meal-macros";
          macros.textContent =
            `${c.calorias.toFixed(1)} kcal ¬∑ ` +
            `${c.proteinas_g.toFixed(1)} g prot ¬∑ ` +
            `${c.grasas_g.toFixed(1)} g grasa ¬∑ ` +
            `${c.azucares_g.toFixed(1)} g az√∫car`;

          div.appendChild(header);
          div.appendChild(desc);
          div.appendChild(macros);

          listaComidasEl.appendChild(div);
        });
    }

    // --- base aprendida ---
    btnBaseAprendida.addEventListener("click", () => {
      actualizarBaseAprendidaUI();
      cambiarPantalla("pantalla-base");
    });

    function actualizarBaseAprendidaUI() {
      listaAprendidaEl.innerHTML = "";

      if (baseAprendida.length === 0) {
        textoSinAprendidaEl.classList.remove("hidden");
        return;
      }

      textoSinAprendidaEl.classList.add("hidden");

      baseAprendida
        .slice()
        .sort((a, b) => a.descripcion.localeCompare(b.descripcion))
        .forEach((item, idx) => {
          const div = document.createElement("div");
          div.className = "learn-item";

          const name = document.createElement("div");
          name.className = "learn-name";
          name.textContent = item.descripcion;

          const macros = document.createElement("div");
          macros.className = "learn-macros";
          macros.textContent =
            `${item.calorias.toFixed(1)} kcal ¬∑ ` +
            `${item.proteinas_g.toFixed(1)} g prot ¬∑ ` +
            `${item.grasas_g.toFixed(1)} g grasa ¬∑ ` +
            `${item.azucares_g.toFixed(1)} g az√∫car`;

          const btnDel = document.createElement("button");
          btnDel.className = "btn-delete";
          btnDel.innerHTML = `<span class="icon">üóëÔ∏è</span><span>Eliminar</span>`;
          btnDel.addEventListener("click", () => {
            if (!confirm("¬øEliminar esta comida de la base aprendida?")) return;
            baseAprendida.splice(idx, 1);
            guardarJSON(STORAGE_BASE, baseAprendida);
            actualizarBaseAprendidaUI();
          });

          div.appendChild(name);
          div.appendChild(macros);
          div.appendChild(btnDel);

          listaAprendidaEl.appendChild(div);
        });
    }

    // --- volver al registro ---
    btnVolverRegistro1.addEventListener("click", () =>
      cambiarPantalla("pantalla-registro")
    );
    btnVolverRegistro2.addEventListener("click", () =>
      cambiarPantalla("pantalla-registro")
    );
  </script>
</body>
</html>