<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CaloriFlow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #1f2937 0, #020617 60%);
      color: #f9fafb;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 16px;
    }

    .app-shell {
      width: 100%;
      max-width: 480px;
      border-radius: 24px;
      background: radial-gradient(circle at top left, #111827, #020617 60%);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
      padding: 24px 20px 32px;
    }

    h1 {
      text-align: center;
      font-size: 32px;
      letter-spacing: 0.08em;
      margin-bottom: 4px;
    }

    .subtitle {
      text-align: center;
      font-size: 14px;
      color: #e5e7eb;
      margin-bottom: 24px;
    }

    .card {
      background: radial-gradient(circle at top left, #020617, #030712 60%);
      border-radius: 20px;
      padding: 18px 16px 20px;
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.1);
    }

    label {
      display: block;
      font-size: 14px;
      margin-bottom: 6px;
      color: #e5e7eb;
    }

    select,
    input[type="number"],
    input[type="text"],
    textarea {
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: #020617;
      color: #f9fafb;
      padding: 10px 12px;
      font-size: 15px;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    select:focus,
    input:focus,
    textarea:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.5);
    }

    .row-3 {
      display: grid;
      grid-template-columns: 1fr 1.1fr 1.4fr;
      gap: 8px;
      margin-top: 12px;
      margin-bottom: 12px;
    }

    .btn {
      width: 100%;
      border: none;
      border-radius: 18px;
      padding: 14px 12px;
      font-size: 16px;
      font-weight: 600;
      margin-top: 10px;
      cursor: pointer;
      transition: transform 0.06s ease, box-shadow 0.06s ease, filter 0.06s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:active {
      transform: scale(0.98);
      filter: brightness(0.95);
      box-shadow: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
      box-shadow: 0 12px 25px rgba(79, 70, 229, 0.5);
    }

    .btn-green {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      box-shadow: 0 10px 20px rgba(16, 185, 129, 0.45);
    }

    .btn-yellow {
      background: linear-gradient(135deg, #facc15, #eab308);
      color: #1f2933;
      box-shadow: 0 10px 20px rgba(234, 179, 8, 0.45);
    }

    .btn-blue {
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      color: #022c44;
      box-shadow: 0 10px 20px rgba(14, 165, 233, 0.45);
    }

    .btn-outline-back {
      background: transparent;
      border-radius: 999px;
      border: 1px solid rgba(251, 191, 36, 0.8);
      color: #facc15;
      padding: 10px 16px;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 16px;
      cursor: pointer;
      transition: background 0.08s ease, color 0.08s ease, transform 0.06s ease;
    }

    .btn-outline-back:active {
      transform: scale(0.97);
      background: rgba(250, 204, 21, 0.08);
    }

    .btn-outline-back span.arrow {
      font-size: 16px;
    }

    .brain-icon {
      font-size: 18px;
    }

    .status-text {
      margin-top: 8px;
      font-size: 13px;
      color: #9ca3af;
    }

    .small-note {
      margin-top: 8px;
      font-size: 12px;
      color: #9ca3af;
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    .summary-title,
    .db-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .summary-sub,
    .db-sub {
      font-size: 13px;
      color: #d1d5db;
      margin-bottom: 14px;
    }

    .totals {
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 16px;
    }

    .meals-list {
      margin-top: 8px;
    }

    .meal-item {
      border-radius: 14px;
      padding: 10px 10px 9px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.9));
      border: 1px solid rgba(55, 65, 81, 0.8);
      margin-bottom: 10px;
    }

    .meal-header {
      font-size: 14px;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
    }

    .meal-type {
      font-weight: 600;
    }

    .meal-time {
      font-size: 11px;
      color: #9ca3af;
      white-space: nowrap;
    }

    .meal-desc {
      font-size: 13px;
      margin-bottom: 3px;
      color: #e5e7eb;
    }

    .meal-macros {
      font-size: 12px;
      color: #cbd5f5;
    }

    .delete-btn {
      margin-top: 6px;
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      background: rgba(239, 68, 68, 0.15);
      color: #fecaca;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .delete-btn:active {
      transform: scale(0.97);
      filter: brightness(0.95);
    }

    .delete-btn span {
      font-size: 13px;
    }

    .section-title {
      font-weight: 600;
      margin-top: 10px;
      margin-bottom: 4px;
      font-size: 14px;
    }

    @media (max-width: 480px) {
      .app-shell {
        padding: 20px 14px 26px;
        border-radius: 0;
        max-width: none;
        height: 100vh;
        max-height: 100vh;
        overflow-y: auto;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div id="screen-registro" class="screen active">
      <h1>CaloriFlow</h1>
      <div class="subtitle">Registro diario con memoria propia.</div>

      <div class="card">
        <div class="field">
          <label for="tipo">Tipo de comida</label>
          <select id="tipo">
            <option>Desayuno</option>
            <option>Almuerzo</option>
            <option>Merienda</option>
            <option>Cena</option>
            <option>Snack</option>
          </select>
        </div>

        <div class="field" style="margin-top: 14px;">
          <label for="descripcion">¬øQu√© comiste?</label>
          <textarea id="descripcion" placeholder="Ej: 1 taza de caf√© con leche"></textarea>
        </div>

        <div class="row-3">
          <div>
            <label for="cantidad">Cant.</label>
            <input type="number" id="cantidad" min="1" step="1" value="1">
          </div>
          <div>
            <label for="porcion">Porci√≥n</label>
            <select id="porcion">
              <option value="taza">taza</option>
              <option value="vaso">vaso</option>
              <option value="unidad">unidad</option>
              <option value="porci√≥n">porci√≥n</option>
              <option value="rebanada">rebanada</option>
              <option value="plato">plato</option>
            </select>
          </div>
          <div>
            <label for="alimento">Alimento</label>
            <input type="text" id="alimento" placeholder="Caf√©, tostada, fruta...">
          </div>
        </div>

        <button id="prompt-btn" class="btn btn-primary">
          <span class="brain-icon">üß†</span>
          <span>Generar prompt para ChatGPT</span>
        </button>
        <div class="status-text">
          Se copiar√° el prompt al portapapeles. Abr√≠ tu ChatGPT y pegalo en la conversaci√≥n que quieras.
        </div>

        <div class="field" style="margin-top: 14px;">
          <label for="json-input">Pega aqu√≠ el resultado de ChatGPT (JSON)</label>
          <textarea id="json-input"></textarea>
        </div>

        <button id="add-btn" class="btn btn-green">
          ‚úÖ Agregar comida
        </button>

        <button id="summary-btn" class="btn btn-yellow">
          üìä Ver resumen de hoy
        </button>

        <button id="db-btn" class="btn btn-blue">
          üìö Ver base aprendida
        </button>

        <div class="small-note">
          Todo se guarda solo en este dispositivo usando memoria local.
        </div>
      </div>
    </div>

    <div id="screen-resumen" class="screen">
      <button id="back-from-summary" class="btn-outline-back">
        <span class="arrow">‚Üê</span> Volver al registro
      </button>

      <div class="card">
        <div class="summary-title">Resumen de hoy</div>
        <div class="summary-sub">
          Suma de todas las comidas registradas hoy.
        </div>

        <div id="totals" class="totals"></div>

        <div class="section-title">Comidas registradas</div>
        <div id="meals-list" class="meals-list"></div>
      </div>
    </div>

    <div id="screen-db" class="screen">
      <button id="back-from-db" class="btn-outline-back">
        <span class="arrow">‚Üê</span> Volver al registro
      </button>

      <div class="card">
        <div class="db-title">Base aprendida</div>
        <div class="db-sub">
          Comidas que la app ya conoce. Si repet√≠s una descripci√≥n, usar√° estos valores sin pedir de nuevo a ChatGPT.
        </div>

        <div id="db-list" class="meals-list"></div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_MEALS_KEY = "caloriflow_meals_v2";
    const STORAGE_DB_KEY = "caloriflow_db_v2";

    function loadMeals() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_MEALS_KEY)) || [];
      } catch {
        return [];
      }
    }

    function saveMeals(meals) {
      localStorage.setItem(STORAGE_MEALS_KEY, JSON.stringify(meals));
    }

    function loadDb() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_DB_KEY)) || {};
      } catch {
        return {};
      }
    }

    function saveDb(db) {
      localStorage.setItem(STORAGE_DB_KEY, JSON.stringify(db));
    }

    let meals = loadMeals();
    let learnedDb = loadDb();

    const screenRegistro = document.getElementById("screen-registro");
    const screenResumen = document.getElementById("screen-resumen");
    const screenDb = document.getElementById("screen-db");

    const tipoInput = document.getElementById("tipo");
    const descripcionInput = document.getElementById("descripcion");
    const cantidadInput = document.getElementById("cantidad");
    const porcionInput = document.getElementById("porcion");
    const alimentoInput = document.getElementById("alimento");
    const jsonInput = document.getElementById("json-input");

    const promptBtn = document.getElementById("prompt-btn");
    const addBtn = document.getElementById("add-btn");
    const summaryBtn = document.getElementById("summary-btn");
    const dbBtn = document.getElementById("db-btn");
    const backFromSummaryBtn = document.getElementById("back-from-summary");
    const backFromDbBtn = document.getElementById("back-from-db");

    const totalsDiv = document.getElementById("totals");
    const mealsListDiv = document.getElementById("meals-list");
    const dbListDiv = document.getElementById("db-list");

    function showScreen(screen) {
      screenRegistro.classList.remove("active");
      screenResumen.classList.remove("active");
      screenDb.classList.remove("active");

      screen.classList.add("active");
    }

    function buildAutoDescription() {
      const descBase = descripcionInput.value.trim();
      const cant = cantidadInput.value.trim();
      const porc = porcionInput.value.trim();
      const alim = alimentoInput.value.trim();

      if (!cant || !porc || !alim) {
        return descBase;
      }

      const descFromParts = `${cant} ${porc} de ${alim}`.trim();

      if (!descBase) return descFromParts;
      if (descBase.includes(descFromParts)) return descBase;
      return `${descBase}, ${descFromParts}`;
    }

    promptBtn.addEventListener("click", async () => {
      const tipo = tipoInput.value;
      const descripcion = buildAutoDescription() || descripcionInput.value.trim();

      if (!descripcion) {
        alert("Primero escrib√≠ qu√© comiste.");
        return;
      }

      descripcionInput.value = descripcion;

      const prompt = `
Quiero que estimes calor√≠as, az√∫cares (g), grasas (g) y prote√≠nas (g) de esta comida:
Tipo de comida: ${tipo}
Descripci√≥n: ${descripcion}

Responde SOLO un JSON v√°lido, sin texto extra, sin comentarios, sin explicaci√≥n.
Usa exactamente este formato de claves:
{"calorias":0,"azucares_g":0,"grasas_g":0,"proteinas_g":0}
Completa los valores con n√∫meros (pueden ser decimales).`.trim();

      try {
        await navigator.clipboard.writeText(prompt);
        alert("Prompt copiado al portapapeles. Abr√≠ tu ChatGPT y pegalo en la conversaci√≥n que quieras.");
      } catch (e) {
        console.error(e);
        alert("No pude copiar al portapapeles. Copi√° el prompt manualmente.");
      }
    });

    function parseJsonFromInput() {
      const raw = jsonInput.value.trim();
      if (!raw) return null;
      try {
        const obj = JSON.parse(raw);
        const needed = ["calorias", "azucares_g", "grasas_g", "proteinas_g"];
        for (const key of needed) {
          if (typeof obj[key] !== "number") {
            throw new Error("Formato incorrecto");
          }
        }
        return obj;
      } catch (e) {
        alert("El JSON no es v√°lido. Revis√° que tenga solo n√∫meros y las claves correctas.");
        return null;
      }
    }

    function findMacrosFromDb(description) {
      const exact = description.trim();
      if (!exact) return null;

      if (learnedDb[exact]) {
        return { ...learnedDb[exact] };
      }

      const parts = exact.split("+").map(p => p.trim()).filter(p => p.length > 0);

      if (parts.length <= 1) {
        return null;
      }

      let sum = { calorias: 0, azucares_g: 0, grasas_g: 0, proteinas_g: 0 };

      for (const part of parts) {
        const entry = learnedDb[part];
        if (!entry) {
          return null;
        }
        sum.calorias += Number(entry.calorias) || 0;
        sum.azucares_g += Number(entry.azucares_g) || 0;
        sum.grasas_g += Number(entry.grasas_g) || 0;
        sum.proteinas_g += Number(entry.proteinas_g) || 0;
      }

      return sum;
    }

    addBtn.addEventListener("click", () => {
      const tipo = tipoInput.value;
      const descripcionRaw = buildAutoDescription();
      const descripcion = descripcionRaw || descripcionInput.value.trim();

      if (!descripcion) {
        alert("Escrib√≠ qu√© comiste.");
        return;
      }

      let macros = null;
      const jsonObj = parseJsonFromInput();

      if (jsonObj) {
        macros = jsonObj;
        learnedDb[descripcion] = {
          calorias: Number(jsonObj.calorias) || 0,
          azucares_g: Number(jsonObj.azucares_g) || 0,
          grasas_g: Number(jsonObj.grasas_g) || 0,
          proteinas_g: Number(jsonObj.proteinas_g) || 0
        };
        saveDb(learnedDb);
      } else {
        macros = findMacrosFromDb(descripcion);
        if (!macros) {
          alert("Comida nueva para la app. Pedile los datos a ChatGPT una vez y peg√° el JSON.");
          return;
        }
      }

      const now = new Date();
      const timeStr = now.toLocaleTimeString("es-UY", { hour: "2-digit", minute: "2-digit", second: "2-digit" });

      const meal = {
        tipo,
        descripcion,
        calorias: Number(macros.calorias) || 0,
        azucares_g: Number(macros.azucares_g) || 0,
        grasas_g: Number(macros.grasas_g) || 0,
        proteinas_g: Number(macros.proteinas_g) || 0,
        time: timeStr,
        date: now.toISOString().slice(0, 10)
      };

      meals.push(meal);
      saveMeals(meals);

      jsonInput.value = "";
      descripcionInput.value = "";
      alimentoInput.value = "";
      cantidadInput.value = "1";

      alert("Comida guardada.");
    });

    function renderSummary() {
      const today = new Date().toISOString().slice(0, 10);
      const todayMeals = meals.filter(m => m.date === today);

      let total = { calorias: 0, azucares_g: 0, grasas_g: 0, proteinas_g: 0 };
      todayMeals.forEach(m => {
        total.calorias += m.calorias;
        total.azucares_g += m.azucares_g;
        total.grasas_g += m.grasas_g;
        total.proteinas_g += m.proteinas_g;
      });

      totalsDiv.innerHTML = `
        Calor√≠as totales: <strong>${total.calorias.toFixed(1)}</strong><br>
        Az√∫cares totales (g): <strong>${total.azucares_g.toFixed(1)}</strong><br>
        Grasas totales (g): <strong>${total.grasas_g.toFixed(1)}</strong><br>
        Prote√≠nas totales (g): <strong>${total.proteinas_g.toFixed(1)}</strong>
      `;

      mealsListDiv.innerHTML = "";
      if (todayMeals.length === 0) {
        mealsListDiv.textContent = "Todav√≠a no registraste comidas hoy.";
        return;
      }

      todayMeals.forEach((m, index) => {
        const item = document.createElement("div");
        item.className = "meal-item";

        const header = document.createElement("div");
        header.className = "meal-header";

        const typeSpan = document.createElement("span");
        typeSpan.className = "meal-type";
        typeSpan.textContent = m.tipo;

        const timeSpan = document.createElement("span");
        timeSpan.className = "meal-time";
        timeSpan.textContent = m.time;

        header.appendChild(typeSpan);
        header.appendChild(timeSpan);

        const desc = document.createElement("div");
        desc.className = "meal-desc";
        desc.textContent = "- " + m.descripcion;

        const macrosDiv = document.createElement("div");
        macrosDiv.className = "meal-macros";
        macrosDiv.textContent =
          `${m.calorias.toFixed(1)} kcal ¬∑ ` +
          `${m.proteinas_g.toFixed(1)} g prot ¬∑ ` +
          `${m.grasas_g.toFixed(1)} g grasa ¬∑ ` +
          `${m.azucares_g.toFixed(1)} g az√∫car`;

        const delBtn = document.createElement("button");
        delBtn.className = "delete-btn";
        delBtn.innerHTML = `<span>üóëÔ∏è</span> Eliminar`;
        delBtn.addEventListener("click", () => {
          if (!confirm("¬øEliminar esta comida del registro de hoy?")) return;
          const globalIndex = meals.findIndex(
            x => x === m
          );
          if (globalIndex >= 0) {
            meals.splice(globalIndex, 1);
            saveMeals(meals);
            renderSummary();
          }
        });

        item.appendChild(header);
        item.appendChild(desc);
        item.appendChild(macrosDiv);
        item.appendChild(delBtn);

        mealsListDiv.appendChild(item);
      });
    }

    function renderDb() {
      dbListDiv.innerHTML = "";

      const entries = Object.entries(learnedDb);
      if (entries.length === 0) {
        dbListDiv.textContent = "Todav√≠a no hay comidas aprendidas.";
        return;
      }

      entries.forEach(([desc, vals]) => {
        const item = document.createElement("div");
        item.className = "meal-item";

        const header = document.createElement("div");
        header.className = "meal-header";

        const descSpan = document.createElement("div");
        descSpan.className = "meal-desc";
        descSpan.textContent = desc;

        const dummy = document.createElement("span");
        dummy.textContent = "";
        header.appendChild(descSpan);
        header.appendChild(dummy);

        const macrosDiv = document.createElement("div");
        macrosDiv.className = "meal-macros";
        macrosDiv.textContent =
          `${(vals.calorias ?? 0).toFixed(1)} kcal ¬∑ ` +
          `${(vals.proteinas_g ?? 0).toFixed(1)} g prot ¬∑ ` +
          `${(vals.grasas_g ?? 0).toFixed(1)} g grasa ¬∑ ` +
          `${(vals.azucares_g ?? 0).toFixed(1)} g az√∫car`;

        const delBtn = document.createElement("button");
        delBtn.className = "delete-btn";
        delBtn.innerHTML = `<span>üóëÔ∏è</span> Eliminar`;
        delBtn.addEventListener("click", () => {
          if (!confirm("¬øEliminar esta entrada de la base aprendida?")) return;
          delete learnedDb[desc];
          saveDb(learnedDb);
          renderDb();
        });

        item.appendChild(header);
        item.appendChild(macrosDiv);
        item.appendChild(delBtn);
        dbListDiv.appendChild(item);
      });
    }

    summaryBtn.addEventListener("click", () => {
      renderSummary();
      showScreen(screenResumen);
    });

    dbBtn.addEventListener("click", () => {
      renderDb();
      showScreen(screenDb);
    });

    backFromSummaryBtn.addEventListener("click", () => {
      showScreen(screenRegistro);
    });

    backFromDbBtn.addEventListener("click", () => {
      showScreen(screenRegistro);
    });
  </script>
</body>
</html>