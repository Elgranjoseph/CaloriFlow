<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CaloriFlow</title>
  <style>
    :root {
      --bg-main: #050714;
      --bg-card: #16192e;
      --bg-card-soft: #1e2140;
      --accent-purple: #7c4dff;
      --accent-green: #00c853;
      --accent-yellow: #ffeb3b;
      --accent-blue: #29b6f6;
      --accent-red: #ff5252;
      --text-main: #ffffff;
      --text-soft: #c7c7d9;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #232a54 0, #050714 55%, #000000 100%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 520px;
      padding: 20px 14px 32px;
    }

    .card {
      background: var(--bg-card);
      border-radius: 26px;
      padding: 20px 16px 24px;
      box-shadow: 0 24px 40px rgba(0, 0, 0, 0.7);
    }

    h1 {
      text-align: center;
      margin: 0 0 4px;
      font-size: 2.4rem;
      letter-spacing: 0.03em;
    }

    .subtitle {
      text-align: center;
      margin-bottom: 18px;
      color: var(--text-soft);
      font-size: 0.95rem;
    }

    label {
      display: block;
      text-align: left;
      font-size: 0.9rem;
      margin: 8px 4px 4px;
      color: var(--text-soft);
    }

    select,
    textarea,
    input {
      width: 100%;
      border-radius: 14px;
      border: 1px solid #303457;
      padding: 11px 13px;
      background: #080a18;
      color: var(--text-main);
      font-size: 0.98rem;
      outline: none;
    }

    textarea {
      min-height: 52px;
      resize: vertical;
      max-height: 160px;
    }

    select:focus,
    textarea:focus,
    input:focus {
      border-color: var(--accent-purple);
      box-shadow: 0 0 0 1px rgba(124, 77, 255, 0.3);
    }

    .row {
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }

    .row > div { flex: 1; }

    .btn {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 14px 16px;
      font-size: 1.03rem;
      font-weight: 600;
      margin-top: 12px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.12s ease, filter 0.12s ease;
    }

    .btn span { vertical-align: middle; }

    .btn-purple {
      background: var(--accent-purple);
      color: white;
      box-shadow: 0 10px 26px rgba(124, 77, 255, 0.45);
    }

    .btn-green {
      background: var(--accent-green);
      color: #021202;
      box-shadow: 0 10px 26px rgba(0, 200, 83, 0.4);
    }

    .btn-yellow {
      background: var(--accent-yellow);
      color: #2a2100;
      box-shadow: 0 10px 26px rgba(255, 235, 59, 0.35);
    }

    .btn-blue {
      background: var(--accent-blue);
      color: #021018;
      box-shadow: 0 10px 26px rgba(41, 182, 246, 0.4);
    }

    .btn-red {
      background: var(--accent-red);
      color: white;
    }

    .btn-back {
      background: #ff9800;
      color: #180905;
      width: auto;
      padding-inline: 18px;
      margin-bottom: 10px;
      box-shadow: 0 8px 18px rgba(255, 152, 0, 0.45);
    }

    .btn-meta {
      background: #455a64;
      color: #ffffff;
      font-size: 0.9rem;
      padding: 9px 14px;
      box-shadow: 0 6px 16px rgba(69, 90, 100, 0.6);
      margin-top: 8px;
      width: auto;
    }

    .screen { display: none; }
    .screen.active { display: block; }

    .section-title {
      text-align: left;
      margin: 6px 4px 4px;
      font-weight: 600;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      margin: 4px 2px;
      font-size: 0.95rem;
    }

    .bar-container {
      width: 100%;
      background: #15182b;
      border-radius: 999px;
      overflow: hidden;
      height: 8px;
      margin: 3px 0 10px;
    }

    .bar {
      height: 100%;
      background: linear-gradient(90deg, #00c853, #ffd54f);
      width: 0%;
      transition: width 0.4s ease;
    }

    .registered-item {
      background: var(--bg-card-soft);
      padding: 10px 12px;
      border-radius: 12px;
      margin-top: 8px;
      text-align: left;
      font-size: 0.9rem;
    }

    .registered-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 6px;
    }

    .pill {
      font-size: 0.8rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #262b4a;
      color: #d2d6ff;
    }

    .delete-small {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.78rem;
      background: #ff5252;
      color: white;
      cursor: pointer;
    }

    .msg {
      margin-top: 10px;
      font-size: 0.9rem;
      color: var(--text-soft);
      text-align: left;
    }

    .footer-note {
      margin-top: 14px;
      font-size: 0.75rem;
      color: var(--text-soft);
      text-align: center;
    }

    .meta-box {
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 18px;
      background: #10132b;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .meta-box label {
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .meta-box input {
      font-size: 0.9rem;
      padding: 8px 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- PANTALLA REGISTRO -->
    <div id="pantalla-registro" class="screen active">
      <div class="card">
        <h1>CaloriFlow</h1>
        <p class="subtitle">Registro diario con memoria propia.</p>

        <label for="tipoComida">Tipo de comida</label>
        <select id="tipoComida">
          <option>Desayuno</option>
          <option>Almuerzo</option>
          <option>Merienda</option>
          <option>Cena</option>
          <option>Snack</option>
        </select>

        <label for="descripcion">¬øQu√© comiste?</label>
        <textarea id="descripcion" placeholder="Ej: 1 taza de caf√© con leche"></textarea>

        <!-- Atajo: cantidad / porci√≥n / alimento -->
        <div class="row">
          <div>
            <label for="cantidad">Cant.</label>
            <input id="cantidad" type="number" min="1" step="1" value="1">
          </div>
          <div>
            <label for="unidad">Porci√≥n</label>
            <select id="unidad">
              <option value="taza">taza</option>
              <option value="vaso">vaso</option>
              <option value="porci√≥n">porci√≥n</option>
              <option value="unidad">unidad</option>
              <option value="cucharada">cucharada</option>
            </select>
          </div>
          <div>
            <label for="alimento">Alimento</label>
            <input id="alimento" type="text" placeholder="caf√©, arroz, manzana...">
          </div>
        </div>

        <button class="btn btn-purple" id="btnPrompt">
          üß† <span>Generar prompt para ChatGPT</span>
        </button>

        <label for="jsonInput" style="margin-top:14px;">Pega aqu√≠ el resultado de ChatGPT (JSON)</label>
        <textarea id="jsonInput" placeholder="Pega aqu√≠ el resultado de ChatGPT"></textarea>

        <button class="btn btn-green" id="btnAgregar">
          ‚úÖ <span>Agregar comida</span>
        </button>

        <button class="btn btn-yellow" id="btnResumen">
          üìä <span>Ver resumen de hoy</span>
        </button>

        <button class="btn btn-blue" id="btnBaseAprendida">
          üìö <span>Ver base aprendida</span>
        </button>

        <p class="footer-note">
          Todo se guarda solo en este dispositivo (memoria local).
        </p>
      </div>
    </div>

    <!-- PANTALLA RESUMEN -->
    <div id="pantalla-resumen" class="screen">
      <div class="card">
        <button class="btn btn-back" id="btnVolverRegistro">‚Üê Volver al registro</button>
        <h2 style="text-align:left;margin:4px 0 4px;">Resumen de hoy</h2>

        <!-- Metas diarias -->
        <div class="meta-box">
          <div class="section-title" style="margin-top:0;">Metas diarias</div>
          <div class="row">
            <div>
              <label for="metaCalorias">Calor√≠as</label>
              <input id="metaCalorias" type="number" min="0" step="10" placeholder="2000">
            </div>
            <div>
              <label for="metaAzucares">Az√∫cares (g)</label>
              <input id="metaAzucares" type="number" min="0" step="1" placeholder="50">
            </div>
          </div>
          <div class="row">
            <div>
              <label for="metaGrasas">Grasas (g)</label>
              <input id="metaGrasas" type="number" min="0" step="1" placeholder="60">
            </div>
            <div>
              <label for="metaProteinas">Prote√≠nas (g)</label>
              <input id="metaProteinas" type="number" min="0" step="1" placeholder="70">
            </div>
          </div>
          <button class="btn btn-meta" id="btnGuardarMetas">
            üíæ Guardar metas
          </button>
        </div>

        <div id="resumen-numeros"></div>
        <div id="resumen-barras"></div>
        <div id="mensaje-resumen" class="msg"></div>

        <h3 class="section-title">Comidas registradas</h3>
        <div id="lista-comidas"></div>
      </div>
    </div>

    <!-- PANTALLA BASE APRENDIDA -->
    <div id="pantalla-base" class="screen">
      <div class="card">
        <button class="btn btn-back" id="btnVolverRegistro2">‚Üê Volver al registro</button>
        <h2 style="text-align:left;margin:4px 0 4px;">Base aprendida</h2>
        <p class="msg">
          Cada vez que registr√°s una comida con JSON, se guarda aqu√≠.
          Si dej√°s el JSON vac√≠o y escrib√≠s una comida igual, la app usa estos valores sin volver a preguntarle a la IA.
        </p>
        <div id="lista-base"></div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_COMIDAS = "caloriflow_comidas_v3";
    const STORAGE_BASE = "caloriflow_base_v3";
    const STORAGE_METAS = "caloriflow_metas_v1";
    const STORAGE_AVISO = "caloriflow_aviso_hoy";

    const DEFAULT_METAS = {
      calorias: 2000,
      azucares_g: 50,
      grasas_g: 60,
      proteinas_g: 70
    };

    let comidas = JSON.parse(localStorage.getItem(STORAGE_COMIDAS) || "[]");
    let baseAprendida = JSON.parse(localStorage.getItem(STORAGE_BASE) || "{}");
    let metas = JSON.parse(localStorage.getItem(STORAGE_METAS) || "null") || { ...DEFAULT_METAS };

    let ultimoRegistro = obtenerUltimoRegistro();
    iniciarRecordatorio();

    function guardarEstado() {
      localStorage.setItem(STORAGE_COMIDAS, JSON.stringify(comidas));
      localStorage.setItem(STORAGE_BASE, JSON.stringify(baseAprendida));
      localStorage.setItem(STORAGE_METAS, JSON.stringify(metas));
    }

    function mostrarPantalla(id) {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    function construirDescripcion() {
      const descLibre = document.getElementById("descripcion").value.trim();
      const cantidad = document.getElementById("cantidad").value.trim();
      const unidad = document.getElementById("unidad").value.trim();
      const alimento = document.getElementById("alimento").value.trim();

      if (descLibre) return descLibre;
      if (cantidad && alimento) return `${cantidad} ${unidad} de ${alimento}`;
      return "";
    }

    function normalizarClaveDesc(texto) {
      return texto.toLowerCase().replace(/\s+/g, " ").trim();
    }

    // BOT√ìN GENERAR PROMPT
    document.getElementById("btnPrompt").addEventListener("click", async () => {
      const tipo = document.getElementById("tipoComida").value;
      const descripcion = construirDescripcion();

      if (!descripcion) {
        alert("Escrib√≠ qu√© comiste o us√° el atajo de cantidad / porci√≥n / alimento.");
        return;
      }

      const prompt = `
Quiero que estimes los valores nutricionales aproximados de esta comida.

Tipo de comida: ${tipo}
Descripci√≥n: "${descripcion}"

RESPONDE SOLO un JSON V√ÅLIDO, en UNA sola l√≠nea, sin texto extra, sin comentarios, sin explicaci√≥n.
Usa exactamente estas claves:

{
  "calorias": 0,
  "azucares_g": 0,
  "grasas_g": 0,
  "proteinas_g": 0
}

Rellena los valores con n√∫meros (pueden ser decimales) seg√∫n tu mejor estimaci√≥n.
      `.trim();

      try {
        await navigator.clipboard.writeText(prompt);
      } catch (e) {
        console.warn("No se pudo copiar al portapapeles:", e);
      }

      const encoded = encodeURIComponent(prompt);
      const chatUrl = `https://chat.openai.com/?q=${encoded}`;
      window.open(chatUrl, "_blank");
    });

    // Agregar comida
    document.getElementById("btnAgregar").addEventListener("click", () => {
      const tipo = document.getElementById("tipoComida").value;
      const descripcion = construirDescripcion();

      if (!descripcion) {
        alert("Falta la descripci√≥n de la comida.");
        return;
      }

      const clave = normalizarClaveDesc(descripcion);
      const jsonTexto = document.getElementById("jsonInput").value.trim();
      let datos;

      if (jsonTexto) {
        try {
          datos = JSON.parse(jsonTexto);
        } catch (e) {
          alert("El JSON que pegaste no es v√°lido. Revis√° comillas y formato.");
          return;
        }
        baseAprendida[clave] = {
          calorias: Number(datos.calorias) || 0,
          azucares_g: Number(datos.azucares_g) || 0,
          grasas_g: Number(datos.grasas_g) || 0,
          proteinas_g: Number(datos.proteinas_g) || 0
        };
      } else {
        if (baseAprendida[clave]) {
          datos = baseAprendida[clave];
        } else {
          alert("Para esta comida a√∫n no hay datos guardados. Pedile primero a ChatGPT, peg√° el JSON y guard√° una vez.");
          return;
        }
      }

      const ahora = new Date().toISOString();
      const registro = {
        tipo,
        descripcion,
        ...datos,
        fechaISO: ahora
      };

      comidas.push(registro);
      guardarEstado();

      document.getElementById("jsonInput").value = "";
      ultimoRegistro = ahora;
      localStorage.removeItem(STORAGE_AVISO);
      alert("Comida guardada.");
    });

    // Metas en resumen
    function poblarMetasInputs() {
      document.getElementById("metaCalorias").value = metas.calorias;
      document.getElementById("metaAzucares").value = metas.azucares_g;
      document.getElementById("metaGrasas").value = metas.grasas_g;
      document.getElementById("metaProteinas").value = metas.proteinas_g;
    }

    document.getElementById("btnGuardarMetas").addEventListener("click", () => {
      metas.calorias = Number(document.getElementById("metaCalorias").value) || metas.calorias;
      metas.azucares_g = Number(document.getElementById("metaAzucares").value) || metas.azucares_g;
      metas.grasas_g = Number(document.getElementById("metaGrasas").value) || metas.grasas_g;
      metas.proteinas_g = Number(document.getElementById("metaProteinas").value) || metas.proteinas_g;
      guardarEstado();
      alert("Metas guardadas.");
      construirResumen();
    });

    // Resumen de hoy
    function esHoy(fechaISO) {
      const f = new Date(fechaISO);
      const hoy = new Date();
      return (
        f.getFullYear() === hoy.getFullYear() &&
        f.getMonth() === hoy.getMonth() &&
        f.getDate() === hoy.getDate()
      );
    }

    function construirResumen() {
      const contNumeros = document.getElementById("resumen-numeros");
      const contBarras = document.getElementById("resumen-barras");
      const contLista = document.getElementById("lista-comidas");
      const msg = document.getElementById("mensaje-resumen");

      const hoyComidas = comidas
        .map((c, idx) => ({ ...c, _idxGlobal: idx }))
        .filter(c => esHoy(c.fechaISO));

      contNumeros.innerHTML = "";
      contBarras.innerHTML = "";
      contLista.innerHTML = "";
      msg.textContent = "";

      if (hoyComidas.length === 0) {
        msg.textContent = "Todav√≠a no registraste comidas hoy.";
        return;
      }

      const totales = { calorias: 0, azucares_g: 0, grasas_g: 0, proteinas_g: 0 };

      hoyComidas.forEach(c => {
        totales.calorias += Number(c.calorias) || 0;
        totales.azucares_g += Number(c.azucares_g) || 0;
        totales.grasas_g += Number(c.grasas_g) || 0;
        totales.proteinas_g += Number(c.proteinas_g) || 0;
      });

      function filaNumero(label, valor) {
        const div = document.createElement("div");
        div.className = "stat-row";
        div.innerHTML = `<span>${label}</span><span><b>${valor.toFixed(1)}</b></span>`;
        contNumeros.appendChild(div);
      }

      filaNumero("Calor√≠as totales:", totales.calorias);
      filaNumero("Az√∫cares totales (g):", totales.azucares_g);
      filaNumero("Grasas totales (g):", totales.grasas_g);
      filaNumero("Prote√≠nas totales (g):", totales.proteinas_g);

      function barra(label, valor, meta, clave) {
        const pct = meta > 0 ? Math.min(100, (valor / meta) * 100) : 0;
        const wrap = document.createElement("div");
        wrap.innerHTML = `
          <div class="stat-row"><span>${label}</span><span>${valor.toFixed(1)} / ${meta}</span></div>
          <div class="bar-container"><div class="bar" id="bar-${clave}" style="width:${pct}%"></div></div>
        `;
        contBarras.appendChild(wrap);
      }

      barra("Calor√≠as", totales.calorias, metas.calorias, "cal");
      barra("Az√∫cares (g)", totales.azucares_g, metas.azucares_g, "az");
      barra("Grasas (g)", totales.grasas_g, metas.grasas_g, "gr");
      barra("Prote√≠nas (g)", totales.proteinas_g, metas.proteinas_g, "pr");

      if (totales.calorias < metas.calorias * 0.5) {
        msg.textContent = "Vas por debajo de la mitad de tu meta de calor√≠as. Cuid√° de no saltearte comidas importantes.";
      } else if (totales.calorias <= metas.calorias * 1.1) {
        msg.textContent = "Est√°s cerca de la meta diaria de calor√≠as. Bastante equilibrado.";
      } else {
        msg.textContent = "Superaste la meta de calor√≠as de referencia. No es grave un d√≠a, pero est√° bueno tenerlo presente.";
      }

      hoyComidas.forEach(c => {
        const div = document.createElement("div");
        div.className = "registered-item";

        const fechaLocal = new Date(c.fechaISO).toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit"
        });

        div.innerHTML = `
          <div class="registered-item-header">
            <div>
              <span class="pill">${c.tipo}</span>
              <span style="font-size:0.8rem;opacity:.8;margin-left:6px;">${fechaLocal}</span>
            </div>
            <button class="delete-small" data-global="${c._idxGlobal}">Eliminar</button>
          </div>
          <div style="margin-bottom:4px;">- ${c.descripcion}</div>
          <div style="font-size:0.85rem;opacity:.92;">
            ${c.calorias} kcal ¬∑ ${c.proteinas_g} g prot ¬∑ ${c.grasas_g} g grasa ¬∑ ${c.azucares_g} g az√∫car
          </div>
        `;

        contLista.appendChild(div);
      });

      contLista.querySelectorAll(".delete-small").forEach(btn => {
        btn.addEventListener("click", e => {
          const idxGlobal = Number(e.target.getAttribute("data-global"));
          if (!Number.isNaN(idxGlobal)) {
            comidas.splice(idxGlobal, 1);
            guardarEstado();
            construirResumen();
          }
        });
      });
    }

    // Base aprendida
    function construirBaseAprendida() {
      const cont = document.getElementById("lista-base");
      cont.innerHTML = "";

      const claves = Object.keys(baseAprendida);

      if (claves.length === 0) {
        cont.innerHTML = "<p class='msg'>Todav√≠a no hay comidas aprendidas.</p>";
        return;
      }

      claves.forEach(clave => {
        const d = baseAprendida[clave];
        const div = document.createElement("div");
        div.className = "registered-item";
        div.innerHTML = `
          <div class="registered-item-header">
            <div style="font-weight:600;">${clave}</div>
            <button class="delete-small" data-clave="${clave}">Eliminar</button>
          </div>
          <div style="font-size:0.85rem;opacity:.92;">
            ${d.calorias} kcal ¬∑ ${d.proteinas_g} g prot ¬∑ ${d.grasas_g} g grasa ¬∑ ${d.azucares_g} g az√∫car
          </div>
        `;
        cont.appendChild(div);
      });

      cont.querySelectorAll(".delete-small").forEach(btn => {
        btn.addEventListener("click", e => {
          const clave = e.target.getAttribute("data-clave");
          if (confirm("¬øSeguro que quer√©s eliminar esta comida de la base aprendida?")) {
            delete baseAprendida[clave];
            guardarEstado();
            construirBaseAprendida();
          }
        });
      });
    }

    // Navegaci√≥n
    document.getElementById("btnResumen").addEventListener("click", () => {
      poblarMetasInputs();
      construirResumen();
      mostrarPantalla("pantalla-resumen");
    });

    document.getElementById("btnVolverRegistro").addEventListener("click", () => {
      mostrarPantalla("pantalla-registro");
    });

    document.getElementById("btnBaseAprendida").addEventListener("click", () => {
      construirBaseAprendida();
      mostrarPantalla("pantalla-base");
    });

    document.getElementById("btnVolverRegistro2").addEventListener("click", () => {
      mostrarPantalla("pantalla-registro");
    });

    // --- Recordatorio de 3 horas ---
    function obtenerUltimoRegistro() {
      if (comidas.length === 0) return null;
      const ult = comidas[comidas.length - 1];
      return ult.fechaISO || null;
    }

    function iniciarRecordatorio() {
      if (!ultimoRegistro) return;
      setInterval(() => {
        if (!ultimoRegistro) return;

        const ahora = new Date();
        const ultima = new Date(ultimoRegistro);
        const diffMs = ahora - ultima;
        const tresHorasMs = 3 * 60 * 60 * 1000;

        const hoyClave = ahora.toISOString().slice(0, 10);
        const avisoYa = localStorage.getItem(STORAGE_AVISO);

        if (diffMs >= tresHorasMs && avisoYa !== hoyClave) {
          alert("Hace m√°s de 3 horas que no registr√°s ninguna comida hoy. Revis√° si no te salteaste una comida.");
          localStorage.setItem(STORAGE_AVISO, hoyClave);
        }
      }, 5 * 60 * 1000);
    }
  </script>
</body>
</html>