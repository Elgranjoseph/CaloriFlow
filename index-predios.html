<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestor de Predios ANTEL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050816;
      --card: #0f172a;
      --accent: #22c55e;
      --accent-soft: #4ade80;
      --danger: #ef4444;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --border-soft: #1f2937;
      --btn-blue: #3b82f6;
      --btn-yellow: #eab308;
      --btn-cyan: #06b6d4;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #1f2937 0, #020617 45%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 900px;
      background: linear-gradient(145deg, #020617 0, #020617 40%, #020617 100%);
      border-radius: 24px;
      padding: 20px 18px 28px;
      border: 1px solid #1e293b;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
    }

    .app-header {
      text-align: center;
      margin-bottom: 18px;
    }

    .title {
      font-size: 2rem;
      font-weight: 800;
      letter-spacing: 0.03em;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    h2 {
      font-size: 1.05rem;
      margin: 18px 0 8px;
    }

    .card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 18px;
      padding: 16px 14px 18px;
      border: 1px solid var(--border-soft);
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px 11px;
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--text-main);
      font-size: 0.9rem;
      outline: none;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--accent-soft);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.35);
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .row {
      display: grid;
      grid-template-columns: 1.1fr 1.1fr 1.2fr;
      gap: 10px;
    }

    .row-2 {
      display: grid;
      grid-template-columns: 1.1fr 1.1fr;
      gap: 10px;
    }

    .btn {
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 11px 16px;
      font-size: 0.95rem;
      font-weight: 600;
      color: #020617;
      cursor: pointer;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn span.icon {
      font-size: 1.1rem;
    }

    .btn-main { background: var(--accent); }
    .btn-main:active { background: var(--accent-soft); }

    .btn-blue { background: var(--btn-blue); color: #f9fafb; }
    .btn-blue:active { background: #2563eb; }

    .btn-yellow { background: var(--btn-yellow); color: #111827; }
    .btn-yellow:active { background: #ca8a04; }

    .btn-danger { background: var(--danger); color: #f9fafb; }
    .btn-danger:active { background: #b91c1c; }

    .btn-outline {
      background: transparent;
      border: 1px solid #4b5563;
      color: var(--text-main);
    }
    .btn-outline:active {
      background: rgba(148, 163, 184, 0.1);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.7rem;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid #1f2937;
      color: var(--text-soft);
      margin-right: 6px;
      margin-bottom: 4px;
    }

    .pill strong { color: var(--accent-soft); margin-left: 4px; }

    .list {
      max-height: 260px;
      overflow-y: auto;
      margin-top: 8px;
      padding-right: 4px;
    }

    .item {
      border-radius: 14px;
      padding: 10px 10px 8px;
      border: 1px solid #1f2937;
      background: #020617;
      margin-bottom: 8px;
      font-size: 0.8rem;
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      margin-bottom: 4px;
    }

    .item-title {
      font-weight: 600;
      font-size: 0.85rem;
    }

    .chip {
      font-size: 0.7rem;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.15);
      border: 1px solid rgba(59, 130, 246, 0.6);
      color: #bfdbfe;
    }

    .item-meta {
      color: var(--text-soft);
      font-size: 0.75rem;
      margin-bottom: 4px;
    }

    .item-area {
      font-size: 0.78rem;
      color: var(--accent-soft);
      font-weight: 600;
    }

    .item-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 4px;
    }

    .btn-small {
      border-radius: 999px;
      border: none;
      padding: 4px 9px;
      font-size: 0.7rem;
      cursor: pointer;
      background: rgba(148, 163, 184, 0.12);
      color: #e5e7eb;
    }

    .btn-small-danger {
      background: rgba(248, 113, 113, 0.15);
      color: #fecaca;
    }

    .separator {
      height: 1px;
      background: radial-gradient(circle, #4b5563 0, transparent 70%);
      margin: 14px 0 10px;
      opacity: 0.7;
    }

    .text-soft { color: var(--text-soft); font-size: 0.78rem; }

    /* Export */
    .export-actions {
      display: grid;
      grid-template-columns: 1.2fr 1.2fr;
      gap: 8px;
      margin-top: 10px;
    }

    .export-area {
      margin-top: 10px;
    }

    .export-area textarea {
      font-size: 0.78rem;
      min-height: 80px;
      white-space: pre;
    }

    @media (max-width: 640px) {
      .row, .row-2 { grid-template-columns: 1fr; }
      .export-actions { grid-template-columns: 1fr; }
      .app { padding: 16px 12px 22px; border-radius: 16px; }
      .title { font-size: 1.6rem; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="title">Gestor de Predios ANTEL</div>
      <div class="subtitle">Registro de sitios, zonas y √°reas para control de cortes de c√©sped.</div>
    </header>

    <!-- FORMULARIO PRINCIPAL -->
    <section class="card">
      <h2>Nuevo predio</h2>
      <div class="row-2">
        <div>
          <label for="zona">Zona / Departamento</label>
          <input id="zona" type="text" placeholder="Ej: Rocha, Minas, Salto‚Ä¶" />
        </div>
        <div>
          <label for="fecha">Fecha de relevamiento</label>
          <input id="fecha" type="date" />
        </div>
      </div>

      <div class="row-2" style="margin-top: 8px;">
        <div>
          <label for="sigla">Sigla del sitio</label>
          <input id="sigla" type="text" placeholder="Ej: RCH-0123" />
        </div>
        <div>
          <label for="sitio">Nombre / descripci√≥n del sitio</label>
          <input id="sitio" type="text" placeholder="Ej: Predio torre ruta 9 km 123" />
        </div>
      </div>

      <div style="margin-top: 10px;">
        <label for="notas">Notas u orientaci√≥n (opcional)</label>
        <textarea id="notas" placeholder="Referencias, ingreso, coordenadas, etc."></textarea>
      </div>

      <div class="separator"></div>

      <h2>Medidas del predio</h2>
      <div class="text-soft" style="margin-bottom: 6px;">
        Pod√©s cargar un solo rect√°ngulo (largo √ó ancho) o varios sectores. La app suma todas las √°reas.
      </div>

      <!-- Rect√°ngulo r√°pido -->
      <div class="row-2">
        <div>
          <label for="largo">Largo total (m)</label>
          <input id="largo" type="number" min="0" step="0.01" placeholder="Ej: 30" />
        </div>
        <div>
          <label for="ancho">Ancho total (m)</label>
          <input id="ancho" type="number" min="0" step="0.01" placeholder="Ej: 20" />
        </div>
      </div>

      <div class="text-soft" style="margin: 6px 0 4px;">
        Si el predio es irregular, sum√° sectores rectangulares:
      </div>

      <div id="secciones"></div>

      <button class="btn btn-outline" id="btnAgregarSeccion">
        <span class="icon">‚ûï</span> Agregar sector (base √ó altura)
      </button>

      <button class="btn btn-main" id="btnGuardar">
        <span class="icon">üíæ</span> Guardar predio
      </button>

      <div class="separator"></div>

      <div class="text-soft">
        <span class="pill">Total sitios guardados: <strong id="totalSitios">0</strong></span>
        <span class="pill">√Årea total acumulada: <strong id="totalArea">0 m¬≤</strong></span>
      </div>
    </section>

    <!-- BUSCADOR Y LISTADO -->
    <section class="card">
      <h2>Buscar y listar predios</h2>
      <div class="row-2">
        <div>
          <label for="buscarTexto">Buscar por sigla o sitio</label>
          <input id="buscarTexto" type="text" placeholder="Escrib√≠ parte de la sigla o del nombre‚Ä¶" />
        </div>
        <div>
          <label for="filtroZona">Filtrar por zona</label>
          <select id="filtroZona">
            <option value="">Todas las zonas</option>
          </select>
        </div>
      </div>

      <div class="list" id="listaPredios"></div>
    </section>

    <!-- EXPORTAR DATOS -->
    <section class="card">
      <h2>Exportar datos</h2>
      <div class="text-soft">
        Gener√° un resumen de todos los predios en formato tabla (CSV). Lo pod√©s copiar, descargar
        o mandarlo por correo para trabajarlo en la PC (Excel, LibreOffice, etc.).
      </div>

      <div class="export-actions">
        <button class="btn btn-blue" id="btnGenerarExport">
          <span class="icon">üìÑ</span> Generar texto de exportaci√≥n
        </button>
        <button class="btn btn-main" id="btnCopiarExport">
          <span class="icon">üìã</span> Copiar al portapapeles
        </button>
        <button class="btn btn-yellow" id="btnDescargarExport">
          <span class="icon">‚¨áÔ∏è</span> Descargar archivo
        </button>
        <button class="btn btn-cyan btn-outline" id="btnMailExport">
          <span class="icon">‚úâÔ∏è</span> Abrir correo con datos
        </button>
      </div>

      <div class="export-area">
        <label for="exportTexto">Texto generado (pod√©s editarlo o pegarlo donde quieras)</label>
        <textarea id="exportTexto" placeholder="Ac√° va a aparecer el contenido para exportar‚Ä¶"></textarea>
      </div>
    </section>
  </div>

  <script>
    const STORAGE_KEY = "prediosANTEL_v1";

    function hoyISO() {
      const d = new Date();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${d.getFullYear()}-${m}-${day}`;
    }

    function cargarPredios() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      } catch (e) {
        console.error("Error leyendo storage", e);
        return [];
      }
    }

    function guardarPredios(lista) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
    }

    function crearSeccionFila(base = "", altura = "") {
      const cont = document.getElementById("secciones");
      const wrap = document.createElement("div");
      wrap.className = "row-2";
      wrap.style.marginBottom = "6px";

      const col1 = document.createElement("div");
      const col2 = document.createElement("div");

      const label1 = document.createElement("label");
      label1.textContent = "Base (m)";
      const input1 = document.createElement("input");
      input1.type = "number";
      input1.min = "0";
      input1.step = "0.01";
      input1.value = base;

      const label2 = document.createElement("label");
      label2.textContent = "Altura (m)";
      const input2 = document.createElement("input");
      input2.type = "number";
      input2.min = "0";
      input2.step = "0.01";
      input2.value = altura;

      col1.appendChild(label1);
      col1.appendChild(input1);
      col2.appendChild(label2);
      col2.appendChild(input2);

      wrap.appendChild(col1);
      wrap.appendChild(col2);

      cont.appendChild(wrap);
    }

    function calcularAreaTotal() {
      let area = 0;
      const largo = parseFloat(document.getElementById("largo").value.replace(",", ".")) || 0;
      const ancho = parseFloat(document.getElementById("ancho").value.replace(",", ".")) || 0;

      if (largo > 0 && ancho > 0) {
        area += largo * ancho;
      }

      const secciones = document
        .getElementById("secciones")
        .querySelectorAll("input[type='number']");

      for (let i = 0; i < secciones.length; i += 2) {
        const base = parseFloat(secciones[i].value.replace(",", ".")) || 0;
        const altura = parseFloat(secciones[i + 1].value.replace(",", ".")) || 0;
        if (base > 0 && altura > 0) {
          area += base * altura;
        }
      }

      return area;
    }

    function refrescarResumen(lista) {
      const totalSitios = lista.length;
      const totalArea = lista.reduce((acc, p) => acc + (p.areaTotal || 0), 0);
      document.getElementById("totalSitios").textContent = totalSitios;
      document.getElementById("totalArea").textContent = `${totalArea.toFixed(2)} m¬≤`;
    }

    function poblarFiltroZonas(lista) {
      const select = document.getElementById("filtroZona");
      const seleccion = select.value;
      const zonas = Array.from(new Set(lista.map(p => p.zona).filter(z => z && z.trim() !== ""))).sort();
      select.innerHTML = `<option value="">Todas las zonas</option>`;
      zonas.forEach(z => {
        const opt = document.createElement("option");
        opt.value = z;
        opt.textContent = z;
        select.appendChild(opt);
      });
      if (seleccion) select.value = seleccion;
    }

    function renderLista(lista) {
      const cont = document.getElementById("listaPredios");
      cont.innerHTML = "";
      if (!lista.length) {
        cont.innerHTML = `<div class="text-soft">No hay predios guardados todav√≠a.</div>`;
        return;
      }

      lista.forEach((p, idx) => {
        const div = document.createElement("div");
        div.className = "item";

        const header = document.createElement("div");
        header.className = "item-header";

        const title = document.createElement("div");
        title.className = "item-title";
        title.textContent = `${p.sigla || "Sin sigla"} ¬∑ ${p.sitio || "Sin descripci√≥n"}`;

        const chip = document.createElement("div");
        chip.className = "chip";
        chip.textContent = p.zona || "Zona sin especificar";

        header.appendChild(title);
        header.appendChild(chip);

        const meta = document.createElement("div");
        meta.className = "item-meta";
        meta.textContent = `Fecha: ${p.fecha || "-"} ¬∑ Sectores: ${p.secciones?.length || 0}`;

        const area = document.createElement("div");
        area.className = "item-area";
        area.textContent = `√Årea total: ${p.areaTotal?.toFixed(2) || 0} m¬≤`;

        const notas = document.createElement("div");
        notas.className = "item-meta";
        notas.textContent = p.notas ? `Notas: ${p.notas}` : "";

        const footer = document.createElement("div");
        footer.className = "item-footer";
        const btnDel = document.createElement("button");
        btnDel.className = "btn-small btn-small-danger";
        btnDel.textContent = "Eliminar";
        btnDel.onclick = () => {
          if (confirm("¬øEliminar este predio?")) {
            const todos = cargarPredios();
            todos.splice(idx, 1);
            guardarPredios(todos);
            actualizarTodo();
          }
        };
        footer.appendChild(btnDel);

        div.appendChild(header);
        div.appendChild(meta);
        div.appendChild(area);
        if (p.notas) div.appendChild(notas);
        div.appendChild(footer);

        cont.appendChild(div);
      });
    }

    function filtrarYMostrar() {
      const texto = document.getElementById("buscarTexto").value.toLowerCase().trim();
      const zona = document.getElementById("filtroZona").value;

      const lista = cargarPredios().filter(p => {
        const coincideTexto =
          !texto ||
          (p.sigla && p.sigla.toLowerCase().includes(texto)) ||
          (p.sitio && p.sitio.toLowerCase().includes(texto));
        const coincideZona = !zona || p.zona === zona;
        return coincideTexto && coincideZona;
      });

      renderLista(lista);
    }

    function actualizarTodo() {
      const lista = cargarPredios();
      refrescarResumen(lista);
      poblarFiltroZonas(lista);
      filtrarYMostrar();
    }

    function buildExportText() {
      const lista = cargarPredios();
      if (!lista.length) return "";

      const lines = [];
      lines.push("zona;sigla;sitio;fecha;area_m2;notas");

      lista.forEach(p => {
        const cols = [
          p.zona || "",
          p.sigla || "",
          p.sitio || "",
          p.fecha || "",
          (p.areaTotal || 0).toFixed(2),
          (p.notas || "").replace(/\r?\n/g, " ")
        ].map(val => `"${String(val).replace(/"/g, '""')}"`);
        lines.push(cols.join(";"));
      });

      return lines.join("\n");
    }

    // --------- EVENTOS ----------
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("fecha").value = hoyISO();

      document.getElementById("btnAgregarSeccion").addEventListener("click", () => {
        crearSeccionFila();
      });

      document.getElementById("btnGuardar").addEventListener("click", () => {
        const zona = document.getElementById("zona").value.trim();
        const fecha = document.getElementById("fecha").value;
        const sigla = document.getElementById("sigla").value.trim();
        const sitio = document.getElementById("sitio").value.trim();
        const notas = document.getElementById("notas").value.trim();

        const area = calcularAreaTotal();
        if (!sigla || !sitio) {
          alert("Complet√° al menos sigla y descripci√≥n del sitio.");
          return;
        }
        if (area <= 0) {
          alert("El √°rea calculada es 0. Verific√° las medidas.");
          return;
        }

        const seccionesInputs = document
          .getElementById("secciones")
          .querySelectorAll("input[type='number']");
        const secciones = [];
        for (let i = 0; i < seccionesInputs.length; i += 2) {
          const base = parseFloat(seccionesInputs[i].value.replace(",", ".")) || 0;
          const altura = parseFloat(seccionesInputs[i + 1].value.replace(",", ".")) || 0;
          if (base > 0 && altura > 0) {
            secciones.push({ base, altura, area: base * altura });
          }
        }

        const predio = {
          id: Date.now(),
          zona,
          fecha,
          sigla,
          sitio,
          notas,
          largo: parseFloat(document.getElementById("largo").value.replace(",", ".")) || 0,
          ancho: parseFloat(document.getElementById("ancho").value.replace(",", ".")) || 0,
          secciones,
          areaTotal: area
        };

        const lista = cargarPredios();
        lista.push(predio);
        guardarPredios(lista);

        document.getElementById("largo").value = "";
        document.getElementById("ancho").value = "";
        document.getElementById("secciones").innerHTML = "";

        actualizarTodo();
        alert("Predio guardado correctamente.");
      });

      document.getElementById("buscarTexto").addEventListener("input", filtrarYMostrar);
      document.getElementById("filtroZona").addEventListener("change", filtrarYMostrar);

      // EXPORTAR
      document.getElementById("btnGenerarExport").addEventListener("click", () => {
        const text = buildExportText();
        if (!text) {
          alert("No hay datos para exportar.");
          return;
        }
        const ta = document.getElementById("exportTexto");
        ta.value = text;
        ta.focus();
        ta.select();
      });

      document.getElementById("btnCopiarExport").addEventListener("click", async () => {
        const text = document.getElementById("exportTexto").value || buildExportText();
        if (!text) {
          alert("Primero gener√° el texto de exportaci√≥n.");
          return;
        }
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
            alert("Texto copiado al portapapeles.");
          } else {
            alert("No se pudo usar el portapapeles autom√°tico. Pod√©s seleccionar y copiar a mano.");
          }
        } catch (e) {
          alert("No se pudo copiar autom√°ticamente. Seleccion√° el texto y copi√° a mano.");
        }
      });

      document.getElementById("btnDescargarExport").addEventListener("click", () => {
        const text = document.getElementById("exportTexto").value || buildExportText();
        if (!text) {
          alert("Primero gener√° el texto de exportaci√≥n.");
          return;
        }
        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const hoy = hoyISO();
        a.href = url;
        a.download = `predios_antel_${hoy}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      document.getElementById("btnMailExport").addEventListener("click", () => {
        const text = document.getElementById("exportTexto").value || buildExportText();
        if (!text) {
          alert("Primero gener√° el texto de exportaci√≥n.");
          return;
        }
        const maxLen = 1800; // evitar mails demasiado largos
        const body = encodeURIComponent(text.length > maxLen ? text.slice(0, maxLen) + "\n\n...(recortado)" : text);
        const subject = encodeURIComponent("Listado de predios ANTEL");
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
      });

      actualizarTodo();
    });
  </script>
</body>
</html>